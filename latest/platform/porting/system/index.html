<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<link rel="icon"  href="/favicon.ico" />
<title>System</title>
<meta name="description" content=""/>
<meta name="keywords" content=""/>
<base id="baseURL" href="/latest/" />
<meta id="docsVersion" content="5.5" />
<meta name="last-modified" content="2019-12-23 10:04:18 +0530" />
<meta http-equiv="cache-control" content="max-age=24" />
<meta http-equiv="cache-control" content="no-cache" />
<meta http-equiv="Cache-Control" content="no-store" />
<meta http-equiv="pragma" content="no-cache" />
<meta http-equiv="Expires" content="600" />

<link rel="stylesheet" href="/css/font-awesome.min.css">
<link rel="stylesheet" href="/css/bootstrap.min.css">
<link rel="stylesheet" href="/css/pygments/perldoc.css">
<link rel="stylesheet" href="/css/style.css?v=23122019">
<link rel="stylesheet" href="/css/github.css?v=23122019">

<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-154449679-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'UA-154449679-1');
</script>

</head>
<body class=" latestVersion">
	 
	<header>
    <div class="header">
        <nav class="nav-secondary-tabs affix" >
            <div class="container-fluid">
                <div class="navbar-collapse" aria-expanded="false" style="height: 1px;">
                    <div class="sidebar-toggle">
    <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
    </button>
</div>
<div class="nav-container">
    <a class="logo" href="/" title="Tizen Documentation">
        Tizen
    </a>
    <div id="tabs">
        
        
        <ul class="tabs" id="jsTOCHorizontal">
            <li class="">
                <a href="design/">Design</a>
            </li>
            <li class="active">
                <a href="platform/">Platform</a>
            </li>
            <li class="">
                <a href="application/">Application</a>
            </li>
            <li class=" dropdown">
                <a href="visualstudio/" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">Visual Studio<span class="caret"></span></a>
                <ul class="dropdown-menu nav-main">    
                    <li><a href="visualstudio/vstools/index/">VS Tools for Tizen</a></li>
                    <li><a href="visualstudio/vscode-ext/index/">VS Code Extension For Tizen</li>
                    <li><a href="visualstudio/vstools-mac/overview/">VS For Mac Extension for Tizen</a></li>
                 </ul>
            </li>
            <li class="">
                <a href="tizenstudio/setup/overview/">Tizen Studio</a>
            </li>
             <li class=" dropdown">
                <a href="iot/" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">IoT<span class="caret"></span></a>
                <ul class="dropdown-menu nav-main">
                    <li><a href="iot/extensionsdk/">IoT Extension SDK</a></li>
                    <li><a href="iot/iot-partners/nubison/">IoT partners</a></li>
                 </ul>
            </li>
            <li class="">
                <a href="tizenstudio/setup/overview/">Blogs</a>
            </li>
            <li class="">
                <a href="tizenstudio/setup/overview/">Community</a>
            </li>
        </ul>
    </div>
    <div class="ctrl-right hidden-xs hidden-sm">
        <a href="javascript:void(0)" id="menu-toggle"><i class="fa fa-indent" aria-hidden="true"></i></a>
        <div class="widgetVersionSwitcher"></div>
    </div>
    <div class="search-form">
        <form action="search.html">
            <input class="search-field form-control ds-input st-search-input" value="" name="q" placeholder="Search the docs" type="search" autocomplete="off" spellcheck="false" dir="auto">
            <button type="submit" class="search-button">
                <i class="fa fa-search"></i>
            </button>
        </form>
    </div>
    
</div>

                </div>
            </div>
        </nav>
    </div>
</header>
    <div class="wrapper right-open">
		<div class="container-fluid">
			<div class="row">
				<div class="col-body">
					<main class="col-content content">
						<section class="section">
							<nav class="breadcrumbs bootstrap hidden-sm-down">
   <ol class="breadcrumb list-unstyled" vocab="http://schema.org/" typeof="BreadcrumbList">

       
          
      
      <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
         <a property="item" typeof="WebPage" href="/latest/">
            <span property="name">Documentation</span>
            <meta property="position" content="1" />
         </a>
      </li>
       
          
      
      <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
         <a property="item" typeof="WebPage" href="/latest/platform/">
            <span property="name">Platform</span>
            <meta property="position" content="2" />
         </a>
      </li>
       
          
      
      <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
         <span property="name">System</span>
         <meta property="position" content="3" />
      </li>
      
   </ol>
</nav>


							<div class="widgetLatestVersionNotification"></div>
							<h1 class="page-title">
								System
							</h1>
							<div class="page-read-time">
								<span class="reading-time" title="Estimated read time">
    
    
    52 mins read
    
</span>
							</div>
							<div class="page-content">
								<h1 id="system">System</h1>

<p>You can implement various features related to the System framework and the file system.</p>

<h2 id="partition-and-file-system">Partition and File System</h2>

<p>The following description is an example of the Tizen partition layout. Product vendors can modify the sequence or partition layout for their devices, as needed.</p>

<ol>
  <li>The <code class="highlighter-rouge">boot</code> partition includes the kernel image, boot-loader image, and modem image. It can also contain device driver modules.</li>
  <li>The <code class="highlighter-rouge">rootfs</code> partition is mounted on the root directory. It contains the fundamental frameworks for Tizen and some general utilities for Linux.</li>
  <li>The <code class="highlighter-rouge">system-data</code> partition is mounted on the <code class="highlighter-rouge">/opt</code> directory. It contains the platform database and platform configurations.</li>
  <li>The <code class="highlighter-rouge">user</code> partition can be mounted on the <code class="highlighter-rouge">/opt/usr</code> directory separately. It contains user-installed applications.</li>
  <li>External storages are mounted on <code class="highlighter-rouge">/opt/media</code>.</li>
  <li>The partition image files (<code class="highlighter-rouge">rootfs.img</code>, <code class="highlighter-rouge">system-data.img</code>, and <code class="highlighter-rouge">user.img</code>) can be zipped for downloading, such as <code class="highlighter-rouge">&lt;IMAGE_NAME&gt;.tar.gz</code>.</li>
</ol>

<p>The <code class="highlighter-rouge">/etc/fstab</code> directory must be modified or the <code class="highlighter-rouge">systemd</code> mount units must be added based on the partition layout. Consequently, the <code class="highlighter-rouge">fstab</code> file or system mount unit files for specific devices must be added to the <code class="highlighter-rouge">system-plugin</code> Git repository. The following example shows an <code class="highlighter-rouge">fstab</code> file:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>/dev/root         /               ext4    defaults,noatime 0      1
LABEL=system-data /opt            ext4    defaults,noatime 0      2
LABEL=user        /opt/usr        ext4    defaults,noatime 0      3
</code></pre></div></div>

<h3 id="supported-file-systems">Supported File Systems</h3>

<p>Tizen supports the Extended 4 (Ext 4) file system as the default file system.</p>

<p>To enable support for other file systems, such as JFS, XFS, BTRFS, and Reiserfs, the Tizen kernel must be modified and compiled. The following configuration options must be enabled in the kernel configuration file:</p>

<ul>
  <li><code class="highlighter-rouge">CONFIG_EXT4_FS=y</code></li>
  <li><code class="highlighter-rouge">CONFIG_EXT4_FS_XATTR=y</code></li>
  <li><code class="highlighter-rouge">CONFIG_EXT4_USE_FOR_EXT23=y</code></li>
  <li><code class="highlighter-rouge">CONFIG_EXT4_FS_SECURITY=y</code></li>
</ul>

<h3 id="file-system-hierarchy">File System Hierarchy</h3>

<p>The Tizen directory hierarchy intends to follow the File System Hierarchy Standard (FHS) as much as possible, for compatibility with the Linux world. However, Tizen uses the <code class="highlighter-rouge">/opt</code> directory for Tizen-specific purposes: place all RW data in the <code class="highlighter-rouge">/opt</code> directory.</p>

<p><strong>Figure: File system hierarchy</strong></p>

<p><img src="media/467px-fsh.png" alt="File system hierarchy" /></p>

<p>Directory macros for accessing the Tizen-specific directories are provided in the Tizen platform configuration metafile. The following table lists some example macros.</p>

<p><strong>Table: Example directory macros</strong></p>

<table>
  <thead>
    <tr>
      <th>Directory macro</th>
      <th>Real path</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code class="highlighter-rouge">TZ_SYS_DATA</code></td>
      <td><code class="highlighter-rouge">/opt/data</code></td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">TZ_SYS_SHARE</code></td>
      <td><code class="highlighter-rouge">/opt/share</code></td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">TZ_SYS_VAR</code></td>
      <td><code class="highlighter-rouge">/opt/var</code></td>
    </tr>
  </tbody>
</table>

<h2 id="system-framework">System Framework</h2>

<p>The System framework module abstracts low-level system functions and manages the Tizen system:</p>

<ul>
  <li><code class="highlighter-rouge">systemd</code> requirements for system and service management
    <ul>
      <li>Linux Kernel &gt;= 3.4 , Linux Kernel &gt;= 3.8 for Smack support</li>
      <li><code class="highlighter-rouge">CONFIG_CGROUPS</code>, <code class="highlighter-rouge">CONFIG_TIMERFD</code>, <code class="highlighter-rouge">CONFIG_SIGNALFD</code>, <code class="highlighter-rouge">CONFIG_EPOLL</code>, …</li>
    </ul>
  </li>
  <li>Basic resource requirements (such as CPU, memory) usage management
    <ul>
      <li>Linux Kernel &gt;= 3.10 for <code class="highlighter-rouge">VMPRESSURE</code>, Linux Kernel &gt;= 3.8 for <code class="highlighter-rouge">MEMCG SWAP</code></li>
      <li><code class="highlighter-rouge">CONFIG_CGROUPS</code>, <code class="highlighter-rouge">CONFIG_CGROUP_SCHED</code>, <code class="highlighter-rouge">CONFIG_MEMCG</code>, <code class="highlighter-rouge">CONFIG_MEMCG_SWAP</code>, …</li>
    </ul>
  </li>
  <li><code class="highlighter-rouge">deviced</code> requirements for device and power management
    <ul>
      <li>Device HAL layer porting</li>
    </ul>
  </li>
  <li>
    <p>dlog requirements</p>

    <p>Select a backend for the target environment and enable the appropriate kernel feature:</p>
    <ul>
      <li>Additional KMSG patch for multiple Kmsg backend</li>
      <li>Android™ logger driver for Android log backend</li>
      <li>Userspace logger daemon</li>
    </ul>
  </li>
</ul>

<p>Using the Linux kernel 3.10 or above is recommended.</p>

<p><strong>Figure: System framework</strong></p>

<p><img src="media/800px-systemfw.png" alt="System framework" /></p>

<h3 id="systemd">systemd</h3>

<p><code class="highlighter-rouge">systemd</code> (ver.219) is a system and service manager for the Tizen system. It provides functionalities, such as parallelized service execution, socket and dbus activation for starting services and daemons, on-demand daemon start-up, service process management using Linux <code class="highlighter-rouge">cgroup</code>, automount point support, and service snapshot and restore.</p>

<p>The <code class="highlighter-rouge">systemd</code> core manages all units, such as service, socket, and mount. It stores all log data. When you add a new service daemon, you need to provide the proper system units and unit dependencies.</p>

<p>To use <code class="highlighter-rouge">systemd</code>, you must enable the <code class="highlighter-rouge">cgroup</code> and <code class="highlighter-rouge">autofs</code> options in the <a href="https://wiki.tizen.org/Linux">Linux</a> kernel configuration. It also depends on dbus and some libraries.</p>

<h3 id="resourced">resourced</h3>

<p><code class="highlighter-rouge">resourced</code> is a daemon that manages system resources, such as memory and CPU.</p>

<p>To use most of the <code class="highlighter-rouge">resourced</code> functionalities, you must enable the following <code class="highlighter-rouge">cgroup</code> kernel features:</p>

<ul>
  <li><code class="highlighter-rouge">CONFIG_CGROUPS</code>: Base feature</li>
  <li><code class="highlighter-rouge">CONFIG_CGROUP_SCHED</code>: Controls the CPU share of applications</li>
  <li><code class="highlighter-rouge">CONFIG_MEMCG</code>: Selects the victim in low-memory situations</li>
  <li><code class="highlighter-rouge">CONFIG_FREEZER</code>: Freezes background (and idle) applications</li>
  <li><code class="highlighter-rouge">CONFIG_MEMCG_SWAP</code>, <code class="highlighter-rouge">CONFIG_MEMCG_SWAP_ENABLED</code>: Adds swap management features to memory resource controller. Depends on <code class="highlighter-rouge">CONFIG_MEMCG</code> and <code class="highlighter-rouge">CONFIG_SWAP</code>.</li>
  <li><code class="highlighter-rouge">CONFIG_ZRAM</code>: Creates memory-backed compressed block devices /dev/zramX (X = 0, 1, …). Depends on <code class="highlighter-rouge">CONFIG_ZSMALLOC</code>.</li>
  <li><code class="highlighter-rouge">CONFIG_ZRAM_LZ4_COMPRESS</code>: Enables support for an alternative compression algorithm. By default, ZRAM uses Lempel–Ziv–Oberhumer (LZO).</li>
  <li><code class="highlighter-rouge">CONFIG_ZSWAP</code>: Compresses data in memory before moving them to a storage device.</li>
  <li><code class="highlighter-rouge">CRYPTO_DEFLATE</code>, <code class="highlighter-rouge">CRYPTO_ZLIB</code>, <code class="highlighter-rouge">CRYPTO_LZO</code>, <code class="highlighter-rouge">CRYPTO_LZ4</code>, <code class="highlighter-rouge">CRYPTO_LZ4HC</code>: Compression algorithms available as part of kernel cyrpto API.</li>
</ul>

<blockquote>
  <p><strong>Note</strong></p>

  <p>To use the <code class="highlighter-rouge">resourced</code> freezer feature, you must install the freezer plugin by enabling <code class="highlighter-rouge">CONFIG_FREEZER</code>.</p>
</blockquote>

<h3 id="deviced">deviced</h3>

<p><code class="highlighter-rouge">deviced</code> is a daemon that handles device events, such as the battery level and plug-and-play device status, and provides interfaces to manage devices, such as power, display, and external storages. If your BSP does not provide the Linux kernel-standard interface, these functionalities can require a HAL layer:</p>

<ul>
  <li>Managing the LCD backlight state (on/off/dim)</li>
  <li>Managing the CPU sleep state and handling requests to lock the CPU from sleeping</li>
  <li>Monitoring external devices, such as USB cable, earjack, and charger</li>
  <li>Monitoring the battery level</li>
  <li>Managing external storages, such as SD card and USB storages</li>
  <li>Controlling the vibrator</li>
  <li>Setting the USB configuration for connecting to a host computer</li>
  <li>Powering off the LED, IR, and other features</li>
  <li>Using the device HAL to handle devices and get events</li>
</ul>

<h3 id="dlog">dlog</h3>

<p>Tizen provides 3 logging system backends:</p>

<ul>
  <li>
    <p>Multiple <code class="highlighter-rouge">kmsg</code> backend</p>

    <p>Requires a kernel patch. For more information, see https://lwn.net/Articles/677047/.</p>
  </li>
  <li>
    <p>Android-logger backend</p>

    <p>Utilizes the Android logger driver.</p>
  </li>
  <li>
    <p>User logger backend</p>

    <p>No requirement (you do not have to enable anything from dlog)</p>
  </li>
</ul>

<h3 id="porting-the-smart-development-bridge-sdb">Porting the Smart Development Bridge (SDB)</h3>

<p>SDB is a device management tool used for remote shell command, file transfer, controlling device log out, and USB debugging.</p>

<ul>
  <li>
    <p>To use SDB, you must install a kernel driver.</p>

    <p>For example:</p>
    <ul>
      <li><a href="https://review.tizen.org/git/?p=profile/mobile/platform/kernel/linux-3.10-sc7730.git;a=blob;f=drivers/usb/gadget/slp.c;h=c0d935f5362cc5ae03807d3533fe84df88e8c354;hb=refs/heads/accepted/tizen_mobile">Gadget Driver for SLP based on Android</a></li>
      <li><a href="https://review.tizen.org/git/?p=profile/mobile/platform/kernel/linux-3.10-sc7730.git;a=blob;f=drivers/usb/gadget/f_sdb.c;h=7f334ba01139d6bcbe7668bd84582e078d563638;hb=refs/heads/accepted/tizen_mobile">Gadget Driver for Samsung SDB (based on Android ADB)</a></li>
    </ul>
  </li>
  <li>To recognize the target as a Tizen device, the SDB interface on the target device must have the following information in the USB interface descriptor:
    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  Class: 0xff
  SubClass: 0x20
  Protocol: 0x02
</code></pre></div>    </div>
  </li>
  <li>
    <p>When using multi-configuration, SDB must be located in the first configuration on the target multi-configuration system. The SDB client of the host PC (Linux PC) selects the first configuration.</p>
  </li>
  <li>To recognize the USB cable connection, you must port the External Connector Class (<code class="highlighter-rouge">extcon</code>) to the kernel. If <code class="highlighter-rouge">extcon</code> cannot be ported, you can enable SDB using the following shell command:
    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  /usr/bin/direct_set_debug.sh --sdb-set
</code></pre></div>    </div>
  </li>
</ul>

<h3 id="porting-the-device-hal-interface">Porting the Device HAL Interface</h3>

<p>The device HAL is applied for the hardware-independent platform. The device HAL consists of libraries corresponding to hardware, such as display, external connector, battery, LED, and IR. The HAL is used by <code class="highlighter-rouge">deviced</code> (device daemon) to control hardware, and manages the events of device state changes. <code class="highlighter-rouge">deviced</code> opens the implemented libraries and uses the APIs to control the devices.</p>

<p>OEM developers must implement the API defined in the header files of the <code class="highlighter-rouge">libdevice-node</code> package and compile their libraries (<code class="highlighter-rouge">.so</code> file) for their devices.</p>

<p>The following code snippet shows the device HAL structure:</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#define MAKE_TAG_CONSTANT(A,B,C,D) (((A) &lt;&lt; 24) | ((B) &lt;&lt; 16) | ((C) &lt;&lt; 8) | (D))
#define HARDWARE_INFO_TAG MAKE_TAG_CONSTANT('T','H','I','T')
</span>
<span class="k">struct</span> <span class="n">hw_common</span><span class="p">;</span>
<span class="k">struct</span> <span class="n">hw_info</span> <span class="p">{</span>
    <span class="cm">/* magic must be initialized to HARDWARE_INFO_TAG */</span>
    <span class="kt">uint32_t</span> <span class="n">magic</span><span class="p">;</span>
    <span class="cm">/* HAL version */</span>
    <span class="kt">uint16_t</span> <span class="n">hal_version</span><span class="p">;</span>
    <span class="cm">/* Device version */</span>
    <span class="kt">uint16_t</span> <span class="n">device_version</span><span class="p">;</span>
    <span class="cm">/* Device ID */</span>
    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">id</span><span class="p">;</span>
    <span class="cm">/* Device name */</span>
    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>
    <span class="cm">/* Author name */</span>
    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">author</span><span class="p">;</span>
    <span class="cm">/* Module's dynamic shared object */</span>
    <span class="kt">void</span> <span class="o">*</span><span class="n">dso</span><span class="p">;</span>
    <span class="cm">/* Reserved for future use */</span>
    <span class="kt">uint32_t</span> <span class="n">reserved</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
    <span class="cm">/* Open device */</span>
    <span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">open</span><span class="p">)(</span><span class="k">struct</span> <span class="n">hw_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">id</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hw_common</span> <span class="o">**</span><span class="n">common</span><span class="p">);</span>
    <span class="cm">/* Close device */</span>
    <span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">close</span><span class="p">)(</span><span class="k">struct</span> <span class="n">hw_common</span> <span class="o">*</span><span class="n">common</span><span class="p">);</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">hw_common</span> <span class="p">{</span>
    <span class="cm">/* Indicate to this device information structure */</span>
    <span class="k">struct</span> <span class="n">hw_info</span> <span class="o">*</span><span class="n">info</span><span class="p">;</span>
<span class="p">};</span>
</code></pre></div></div>

<h4 id="battery-hal">Battery HAL</h4>

<p>The battery HAL provides functions for getting the battery status. The HAL interface is defined in the <code class="highlighter-rouge">hw/battery.h</code> header file of the <code class="highlighter-rouge">libdevice-node</code> library, and the <code class="highlighter-rouge">pkg-config</code> <code class="highlighter-rouge">device-node</code> must be used to use the HAL interface.</p>

<p>The following code snippet shows the battery HAL interface:</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/*
   Device ID
*/</span>
<span class="cp">#define BATTERY_HARDWARE_DEVICE_ID "battery"
</span>
<span class="cp">#define POWER_SOURCE_NONE "none"
#define POWER_SOURCE_AC "ac"
#define POWER_SOURCE_USB "usb"
#define POWER_SOURCE_WIRELESS "wireless"
</span>
<span class="cm">/*
   Device version
*/</span>
<span class="cp">#define BATTERY_HARDWARE_DEVICE_VERSION MAKE_VERSION(0,1)
</span>
<span class="k">struct</span> <span class="n">battery_info</span> <span class="p">{</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span> <span class="cm">/* "display" */</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">status</span><span class="p">;</span> <span class="cm">/* "Charging", "Discharging", "Full", "Not charging" */</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">health</span><span class="p">;</span> <span class="cm">/* "Good", "Cold", "Dead", "Overheat", "Over voltage" */</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">power_source</span><span class="p">;</span> <span class="cm">/* "ac", "usb", "wireless" */</span>
    <span class="kt">int</span> <span class="n">online</span><span class="p">;</span> <span class="cm">/* 0 ~ */</span>
    <span class="kt">int</span> <span class="n">present</span><span class="p">;</span> <span class="cm">/* 0 or 1 */</span>
    <span class="kt">int</span> <span class="n">capacity</span><span class="p">;</span> <span class="cm">/* 0 ~ 100 */</span>
    <span class="kt">int</span> <span class="n">current_now</span><span class="p">;</span> <span class="cm">/* Current (uA). Positive value if power source is connected, negative value if power source is not connected */</span>
    <span class="kt">int</span> <span class="n">current_average</span><span class="p">;</span> <span class="cm">/* Average current (uA). Positive value if power source is connected, negative value if power source is not connected */</span>
<span class="p">};</span>

<span class="k">typedef</span> <span class="nf">void</span> <span class="p">(</span><span class="o">*</span><span class="n">BatteryUpdated</span><span class="p">)(</span><span class="k">struct</span> <span class="n">battery_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">);</span>

<span class="k">struct</span> <span class="n">battery_device</span> <span class="p">{</span>
    <span class="k">struct</span> <span class="n">hw_common</span> <span class="n">common</span><span class="p">;</span>

    <span class="cm">/* Register battery event */</span>
    <span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">register_changed_event</span><span class="p">)(</span><span class="n">BatteryUpdated</span> <span class="n">updated_cb</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">);</span>
    <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">unregister_changed_event</span><span class="p">)(</span><span class="n">BatteryUpdated</span> <span class="n">updated_cb</span><span class="p">);</span>

    <span class="cm">/* Get current states */</span>
    <span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">get_current_state</span><span class="p">)(</span><span class="n">BatteryUpdated</span> <span class="n">updated_cb</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">);</span>
<span class="p">};</span>
</code></pre></div></div>

<p>The following table lists the battery HAL functions.</p>

<p><strong>Table: Battery HAL functions</strong></p>

<table>
  <thead>
    <tr>
      <th>Function prototype</th>
      <th>Description</th>
      <th>Mandatory</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code class="highlighter-rouge">int (*register_changed_event)(BatteryUpdated updated_cb, void *data);</code></td>
      <td>Adds a callback function which is called when battery status changes.</td>
      <td>Yes</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">void (*unregister_changed_event)(BatteryUpdated updated_cb);</code></td>
      <td>Removes the callback function added for the battery status event.</td>
      <td>Yes</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">int (*get_current_state)(BatteryUpdated updated_cb, void *data);</code></td>
      <td>Calls the function specified in the first parameter. The battery information is delivered to the function parameter.</td>
      <td>Yes</td>
    </tr>
  </tbody>
</table>

<p>The following code snippet shows an example of the battery HAL:</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#define BATTERY_ROOT_PATH "/sys/class/power_supply"
</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">get_power_source</span><span class="p">(</span><span class="kt">char</span> <span class="o">**</span><span class="n">src</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">val</span><span class="p">;</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="n">sys_get_int</span><span class="p">(</span><span class="n">BATTERY_ROOT_PATH</span><span class="s">"/"</span><span class="n">POWER_SOURCE_AC</span><span class="s">"/online"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">val</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="o">*</span><span class="n">src</span> <span class="o">=</span> <span class="n">POWER_SOURCE_AC</span><span class="p">;</span>

        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">ret</span> <span class="o">=</span> <span class="n">sys_get_int</span><span class="p">(</span><span class="n">BATTERY_ROOT_PATH</span><span class="s">"/"</span><span class="n">POWER_SOURCE_USB</span><span class="s">"/online"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">val</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="o">*</span><span class="n">src</span> <span class="o">=</span> <span class="n">POWER_SOURCE_USB</span><span class="p">;</span>

        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">ret</span> <span class="o">=</span> <span class="n">sys_get_int</span><span class="p">(</span><span class="n">BATTERY_ROOT_PATH</span><span class="s">"/"</span><span class="n">POWER_SOURCE_WIRELESS</span><span class="s">"/online"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">val</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="o">*</span><span class="n">src</span> <span class="o">=</span> <span class="n">POWER_SOURCE_WIRELESS</span><span class="p">;</span>

        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="o">*</span><span class="n">src</span> <span class="o">=</span> <span class="n">POWER_SOURCE_NONE</span><span class="p">;</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">battery_get_current_state</span><span class="p">(</span><span class="n">BatteryUpdated</span> <span class="n">updated_cb</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">fd</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">battery_info</span> <span class="n">info</span><span class="p">;</span>
    <span class="kt">char</span> <span class="n">status</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>
    <span class="kt">char</span> <span class="n">health</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">power_source</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">updated_cb</span><span class="p">)</span>
        <span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

    <span class="n">info</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">BATTERY_HARDWARE_DEVICE_ID</span><span class="p">;</span>


    <span class="n">fd</span> <span class="o">=</span> <span class="n">open</span><span class="p">(</span><span class="n">BATTERY_ROOT_PATH</span><span class="s">"/battery/status"</span><span class="p">,</span> <span class="n">O_RDONLY</span><span class="p">);</span>
    <span class="n">read</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">status</span><span class="p">));</span>
    <span class="n">close</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>
    <span class="n">info</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">status</span><span class="p">;</span>

    <span class="n">fd</span> <span class="o">=</span> <span class="n">open</span><span class="p">(</span><span class="n">BATTERY_ROOT_PATH</span><span class="s">"/battery/health"</span><span class="p">,</span> <span class="n">O_RDONLY</span><span class="p">);</span>
    <span class="n">read</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">health</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">health</span><span class="p">));</span>
    <span class="n">close</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>
    <span class="n">info</span><span class="p">.</span><span class="n">health</span> <span class="o">=</span> <span class="n">health</span><span class="p">;</span>

    <span class="p">....</span>

    <span class="n">get_power_source</span><span class="p">(</span><span class="o">&amp;</span><span class="n">power_source</span><span class="p">);</span>
    <span class="n">info</span><span class="p">.</span><span class="n">power_source</span> <span class="o">=</span> <span class="n">power_source</span><span class="p">;</span>

    <span class="n">updated_cb</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">battery_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">hw_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">id</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hw_common</span> <span class="o">**</span><span class="n">common</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">struct</span> <span class="n">battery_device</span> <span class="o">*</span><span class="n">battery_dev</span><span class="p">;</span>
    <span class="n">battery_dev</span> <span class="o">=</span> <span class="n">calloc</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">battery_device</span><span class="p">));</span>

    <span class="n">battery_dev</span><span class="o">-&gt;</span><span class="n">common</span><span class="p">.</span><span class="n">info</span> <span class="o">=</span> <span class="n">info</span><span class="p">;</span>
    <span class="n">battery_dev</span><span class="o">-&gt;</span><span class="n">register_changed_event</span> <span class="o">=</span> <span class="n">battery_register_changed_event</span><span class="p">;</span>
    <span class="n">battery_dev</span><span class="o">-&gt;</span><span class="n">unregister_changed_event</span> <span class="o">=</span> <span class="n">battery_unregister_changed_event</span><span class="p">;</span>
    <span class="n">battery_dev</span><span class="o">-&gt;</span><span class="n">get_current_state</span> <span class="o">=</span> <span class="n">battery_get_current_state</span><span class="p">;</span>

    <span class="o">*</span><span class="n">common</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">hw_common</span> <span class="o">*</span><span class="p">)</span><span class="n">battery_dev</span><span class="p">;</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">battery_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">hw_common</span> <span class="o">*</span><span class="n">common</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">free</span><span class="p">(</span><span class="n">common</span><span class="p">);</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">HARDWARE_MODULE_STRUCTURE</span> <span class="o">=</span> <span class="p">{</span>
    <span class="p">.</span><span class="n">magic</span> <span class="o">=</span> <span class="n">HARDWARE_INFO_TAG</span><span class="p">,</span>
    <span class="p">.</span><span class="n">hal_version</span> <span class="o">=</span> <span class="n">HARDWARE_INFO_VERSION</span><span class="p">,</span>
    <span class="p">.</span><span class="n">device_version</span> <span class="o">=</span> <span class="n">BATTERY_HARDWARE_DEVICE_VERSION</span><span class="p">,</span>
    <span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">BATTERY_HARDWARE_DEVICE_ID</span><span class="p">,</span>
    <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">"battery"</span><span class="p">,</span>
    <span class="p">.</span><span class="n">open</span> <span class="o">=</span> <span class="n">battery_open</span><span class="p">,</span>
    <span class="p">.</span><span class="n">close</span> <span class="o">=</span> <span class="n">battery_close</span><span class="p">,</span>
<span class="p">};</span>
</code></pre></div></div>

<h4 id="display-hal">Display HAL</h4>

<p>The display HAL provides functions for controlling the display brightness. The HAL interface is defined in the <code class="highlighter-rouge">hw/display.h</code> header file of the <code class="highlighter-rouge">libdevice-node</code> library, and the <code class="highlighter-rouge">pkg-config</code> <code class="highlighter-rouge">device-node</code> must be used to use the HAL interface.</p>

<p>The following code snippet shows the display HAL interface:</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/*
   Device ID
*/</span>
<span class="cp">#define DISPLAY_HARDWARE_DEVICE_ID "display"
</span>
<span class="cm">/*
   Device version
*/</span>
<span class="cp">#define DISPLAY_HARDWARE_DEVICE_VERSION MAKE_VERSION(0,2)
</span>
<span class="k">struct</span> <span class="n">display_device</span> <span class="p">{</span>
    <span class="k">struct</span> <span class="n">hw_common</span> <span class="n">common</span><span class="p">;</span>

    <span class="cm">/* Control display brightness */</span>
    <span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">get_max_brightness</span><span class="p">)(</span><span class="kt">int</span> <span class="o">*</span><span class="n">brightness</span><span class="p">);</span>
    <span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">get_brightness</span><span class="p">)(</span><span class="kt">int</span> <span class="o">*</span><span class="n">brightness</span><span class="p">);</span>
    <span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">set_brightness</span><span class="p">)(</span><span class="kt">int</span> <span class="n">brightness</span><span class="p">);</span>
<span class="p">};</span>
</code></pre></div></div>

<p>The following table lists the display HAL functions.</p>

<p><strong>Table: Display HAL functions</strong></p>

<table>
  <thead>
    <tr>
      <th>Function prototype</th>
      <th>Description</th>
      <th>Mandatory</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code class="highlighter-rouge">int (*get_max_brightness)(int *brightness)</code></td>
      <td>Returns the maximum brightness value the display driver supports.</td>
      <td>Yes</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">int (*get_brightness)(int *brightness)</code></td>
      <td>Returns the current brightness value.</td>
      <td>Yes</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">int (*set_brightness)(int brightness)</code></td>
      <td>Sets the brightness value.</td>
      <td>Yes</td>
    </tr>
  </tbody>
</table>

<p>The following code snippet shows an example of the display HAL:</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#ifndef BACKLIGHT_PATH
#define BACKLIGHT_PATH "/sys/class/backlight/panel"
#endif
</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">display_get_max_brightness</span><span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="n">val</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">static</span> <span class="kt">int</span> <span class="n">max</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="n">BUF_MAX</span><span class="p">];</span>
    <span class="kt">int</span> <span class="n">fd</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">max</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">fd</span> <span class="o">=</span> <span class="n">open</span><span class="p">(</span><span class="n">BACKLIGHT_PATH</span><span class="s">"/max_brightness"</span><span class="p">,</span> <span class="n">O_RDONLY</span><span class="p">);</span>
        <span class="n">read</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">));</span>
        <span class="n">close</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>
        <span class="n">max</span> <span class="o">=</span> <span class="n">atoi</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="o">*</span><span class="n">val</span> <span class="o">=</span> <span class="n">max</span><span class="p">;</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">display_get_brightness</span><span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="n">brightness</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">fd</span><span class="p">;</span>
    <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="n">BUF_MAX</span><span class="p">];</span>
    <span class="n">fd</span> <span class="o">=</span> <span class="n">open</span><span class="p">(</span><span class="n">BACKLIGHT_PATH</span><span class="s">"/brightness"</span><span class="p">,</span> <span class="n">O_RDONLY</span><span class="p">);</span>
    <span class="n">read</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">));</span>
    <span class="n">close</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>
    <span class="o">*</span><span class="n">brightness</span> <span class="o">=</span> <span class="n">atoi</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">display_set_brightness</span><span class="p">(</span><span class="kt">int</span> <span class="n">brightness</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">max</span><span class="p">;</span>
    <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="n">BUF_MAX</span><span class="p">];</span>
    <span class="n">display_get_max_brightness</span><span class="p">(</span><span class="o">&amp;</span><span class="n">max</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">brightness</span> <span class="o">&gt;</span> <span class="n">max</span><span class="p">)</span>
        <span class="n">brightness</span> <span class="o">=</span> <span class="n">max</span><span class="p">;</span>
    <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">),</span> <span class="s">"%d"</span><span class="p">,</span> <span class="n">brightness</span><span class="p">);</span>
    <span class="n">fd</span> <span class="o">=</span> <span class="n">open</span><span class="p">(</span><span class="n">BACKLIGHT_PATH</span><span class="s">"/brightness"</span><span class="p">,</span> <span class="n">O_WRONLY</span><span class="p">);</span>
    <span class="n">write</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">buf</span><span class="p">));</span>
    <span class="n">close</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">display_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">hw_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
        <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">id</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hw_common</span> <span class="o">**</span><span class="n">common</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">struct</span> <span class="n">display_device</span> <span class="o">*</span><span class="n">display_dev</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span> <span class="o">||</span> <span class="o">!</span><span class="n">common</span><span class="p">)</span>
        <span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

    <span class="n">display_dev</span> <span class="o">=</span> <span class="n">calloc</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">display_device</span><span class="p">));</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">display_dev</span><span class="p">)</span>
        <span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

    <span class="n">display_dev</span><span class="o">-&gt;</span><span class="n">common</span><span class="p">.</span><span class="n">info</span> <span class="o">=</span> <span class="n">info</span><span class="p">;</span>
    <span class="n">display_dev</span><span class="o">-&gt;</span><span class="n">get_max_brightness</span> <span class="o">=</span> <span class="n">display_get_max_brightness</span><span class="p">;</span>
    <span class="n">display_dev</span><span class="o">-&gt;</span><span class="n">get_brightness</span> <span class="o">=</span> <span class="n">display_get_brightness</span><span class="p">;</span>
    <span class="n">display_dev</span><span class="o">-&gt;</span><span class="n">set_brightness</span> <span class="o">=</span> <span class="n">display_set_brightness</span><span class="p">;</span>

    <span class="o">*</span><span class="n">common</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">hw_common</span> <span class="o">*</span><span class="p">)</span><span class="n">display_dev</span><span class="p">;</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">display_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">hw_common</span> <span class="o">*</span><span class="n">common</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">common</span><span class="p">)</span>
        <span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

    <span class="n">free</span><span class="p">(</span><span class="n">common</span><span class="p">);</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">HARDWARE_MODULE_STRUCTURE</span> <span class="o">=</span> <span class="p">{</span>
    <span class="p">.</span><span class="n">magic</span> <span class="o">=</span> <span class="n">HARDWARE_INFO_TAG</span><span class="p">,</span>
    <span class="p">.</span><span class="n">hal_version</span> <span class="o">=</span> <span class="n">HARDWARE_INFO_VERSION</span><span class="p">,</span>
    <span class="p">.</span><span class="n">device_version</span> <span class="o">=</span> <span class="n">DISPLAY_HARDWARE_DEVICE_VERSION</span><span class="p">,</span>
    <span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">DISPLAY_HARDWARE_DEVICE_ID</span><span class="p">,</span>
    <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">"Display"</span><span class="p">,</span>
    <span class="p">.</span><span class="n">open</span> <span class="o">=</span> <span class="n">display_open</span><span class="p">,</span>
    <span class="p">.</span><span class="n">close</span> <span class="o">=</span> <span class="n">display_close</span><span class="p">,</span>
<span class="p">};</span>
</code></pre></div></div>

<h4 id="external-connector-hal">External Connector HAL</h4>

<p>The external connector HAL provides functions for getting the external connector device status. The HAL interface is defined in the <code class="highlighter-rouge">hw/external_connection.h</code> header file of the <code class="highlighter-rouge">libdevice-node</code> library, and the <code class="highlighter-rouge">pkg-config</code> <code class="highlighter-rouge">device-node</code> needs to be used to use the HAL interface.</p>

<p>The following code snippet shows the interface of the external connector HAL:</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/*
   Device ID
*/</span>
<span class="cp">#define EXTERNAL_CONNECTION_HARDWARE_DEVICE_ID "external_connection"
</span>
<span class="cp">#define EXTERNAL_CONNECTION_USB "USB"
#define EXTERNAL_CONNECTION_USB_HOST "USB-HOST"
#define EXTERNAL_CONNECTION_TA "TA"
#define EXTERNAL_CONNECTION_HDMI "HDMI"
#define EXTERNAL_CONNECTION_DOCK "Dock"
#define EXTERNAL_CONNECTION_MIC "Microphone"
#define EXTERNAL_CONNECTION_HEADPHONE "Headphone"
</span>
<span class="cm">/*
   Device version
*/</span>
<span class="cp">#define EXTERNAL_CONNECTION_HARDWARE_DEVICE_VERSION MAKE_VERSION(0,1)
</span>
<span class="k">struct</span> <span class="n">connection_info</span> <span class="p">{</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">state</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">flags</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">typedef</span> <span class="nf">void</span> <span class="p">(</span><span class="o">*</span><span class="n">ConnectionUpdated</span><span class="p">)(</span><span class="k">struct</span> <span class="n">connection_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">);</span>

<span class="k">struct</span> <span class="n">external_connection_device</span> <span class="p">{</span>
    <span class="k">struct</span> <span class="n">hw_common</span> <span class="n">common</span><span class="p">;</span>

    <span class="cm">/* Register external_connection event */</span>
    <span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">register_changed_event</span><span class="p">)(</span><span class="n">ConnectionUpdated</span> <span class="n">updated_cb</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">);</span>
    <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">unregister_changed_event</span><span class="p">)(</span><span class="n">ConnectionUpdated</span> <span class="n">updated_cb</span><span class="p">);</span>

    <span class="cm">/* Get current states */</span>
    <span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">get_current_state</span><span class="p">)(</span><span class="n">ConnectionUpdated</span> <span class="n">updated_cb</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">);</span>
<span class="p">};</span>
</code></pre></div></div>

<p>The following table lists the external connector HAL functions.</p>

<p><strong>Table: External connector HAL functions</strong></p>

<table>
  <thead>
    <tr>
      <th>Function prototype</th>
      <th>Description</th>
      <th>Mandatory</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code class="highlighter-rouge">int (*register_changed_event)(ConnectionUpdated updated_cb, void *data);</code></td>
      <td>Adds a callback function which is called when the external connector status changes.</td>
      <td>Yes</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">void (*unregister_changed_event)(ConnectionUpdated updated_cb);</code></td>
      <td>Removes the callback function added for the external connector status event.</td>
      <td>Yes</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">int (*get_current_state)(ConnectionUpdated updated_cb, void *data);</code></td>
      <td>Calls the function specified in the first parameter. The external connector information is delivered to the function parameter.</td>
      <td>Yes</td>
    </tr>
  </tbody>
</table>

<p>The following code snippet shows an example of the external connector HAL:</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#define SWITCH_ROOT_PATH "/sys/devices/virtual/switch"
</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">switch_device</span> <span class="p">{</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">type</span><span class="p">;</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">state</span><span class="p">;</span>
<span class="p">}</span> <span class="n">switch_devices</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
    <span class="p">{</span><span class="n">EXTERNAL_CONNECTION_USB</span><span class="p">,</span> <span class="s">"usb_cable"</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
    <span class="p">{</span><span class="n">EXTERNAL_CONNECTION_DOCK</span><span class="p">,</span> <span class="s">"dock"</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
    <span class="p">{</span><span class="n">EXTERNAL_CONNECTION_HEADPHONE</span><span class="p">,</span> <span class="s">"earjack"</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">read_switch_state</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">path</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">char</span> <span class="n">node</span><span class="p">[</span><span class="mi">128</span><span class="p">],</span> <span class="n">val</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
    <span class="kt">FILE</span> <span class="o">*</span><span class="n">fp</span><span class="p">;</span>

    <span class="n">snprintf</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">node</span><span class="p">),</span> <span class="s">"%s/%s/state"</span><span class="p">,</span> <span class="n">SWITCH_ROOT_PATH</span><span class="p">,</span> <span class="n">path</span><span class="p">);</span>
    <span class="n">fp</span> <span class="o">=</span> <span class="n">fopen</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s">"r"</span><span class="p">);</span>
    <span class="n">fgets</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">val</span><span class="p">),</span> <span class="n">fp</span><span class="p">));</span>
    <span class="n">fclose</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>

    <span class="k">return</span> <span class="n">atoi</span><span class="p">(</span><span class="n">val</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">external_connection_get_current_state</span><span class="p">(</span><span class="n">ConnectionUpdated</span> <span class="n">updated_cb</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">connection_info</span> <span class="n">info</span><span class="p">;</span>
    <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>

    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">switch_devices</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="n">read_switch_state</span><span class="p">(</span><span class="n">switch_devices</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span><span class="p">);</span>
        <span class="n">info</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">switch_devices</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">type</span><span class="p">;</span>
        <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">),</span> <span class="s">"%d"</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
        <span class="n">info</span><span class="p">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
        <span class="n">updated_cb</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">read_switch_state</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">path</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">char</span> <span class="n">node</span><span class="p">[</span><span class="mi">128</span><span class="p">],</span> <span class="n">val</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
    <span class="kt">FILE</span> <span class="o">*</span><span class="n">fp</span><span class="p">;</span>

    <span class="n">snprintf</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">node</span><span class="p">),</span> <span class="s">"%s/%s/state"</span><span class="p">,</span> <span class="n">SWITCH_ROOT_PATH</span><span class="p">,</span> <span class="n">path</span><span class="p">);</span>
    <span class="n">fp</span> <span class="o">=</span> <span class="n">fopen</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s">"r"</span><span class="p">);</span>
    <span class="n">fgets</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">val</span><span class="p">),</span> <span class="n">fp</span><span class="p">));</span>
    <span class="n">fclose</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>

    <span class="k">return</span> <span class="n">atoi</span><span class="p">(</span><span class="n">val</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">external_connection_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">hw_common</span> <span class="o">*</span><span class="n">common</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">free</span><span class="p">(</span><span class="n">common</span><span class="p">);</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">HARDWARE_MODULE_STRUCTURE</span> <span class="o">=</span> <span class="p">{</span>
    <span class="p">.</span><span class="n">magic</span> <span class="o">=</span> <span class="n">HARDWARE_INFO_TAG</span><span class="p">,</span>
    <span class="p">.</span><span class="n">hal_version</span> <span class="o">=</span> <span class="n">HARDWARE_INFO_VERSION</span><span class="p">,</span>
    <span class="p">.</span><span class="n">device_version</span> <span class="o">=</span> <span class="n">EXTERNAL_CONNECTION_HARDWARE_DEVICE_VERSION</span><span class="p">,</span>
    <span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">EXTERNAL_CONNECTION_HARDWARE_DEVICE_ID</span><span class="p">,</span>
    <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">"external_connection"</span><span class="p">,</span>
    <span class="p">.</span><span class="n">open</span> <span class="o">=</span> <span class="n">external_connection_open</span><span class="p">,</span>
    <span class="p">.</span><span class="n">close</span> <span class="o">=</span> <span class="n">external_connection_close</span><span class="p">,</span>
<span class="p">};</span>
</code></pre></div></div>

<h4 id="led-hal">LED HAL</h4>

<p>The LED HAL provides functions for controlling LEDs. The HAL interface is defined in the <code class="highlighter-rouge">hw/led.h</code> header file of the <code class="highlighter-rouge">libdevice-node</code> library, and the <code class="highlighter-rouge">pkg-config</code> <code class="highlighter-rouge">device-node</code> must be used to use the HAL interface.</p>

<p>The following code snippet shows the interface of the LED HAL:</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/*
   Device ID
*/</span>
<span class="cp">#define LED_HARDWARE_DEVICE_ID  "led"
</span>
<span class="cm">/*
   Device version
*/</span>
<span class="cp">#define LED_HARDWARE_DEVICE_VERSION MAKE_VERSION(1,0)
</span>
<span class="cm">/*
   LED device ID
*/</span>
<span class="cp">#define LED_ID_CAMERA_BACK "camera_back"
#define LED_ID_CAMERA_FRONT "camera_front"
#define LED_ID_NOTIFICATION "notification"
#define LED_ID_TOUCH_KEY "touch_key"
</span>
<span class="k">enum</span> <span class="n">led_type</span> <span class="p">{</span>
    <span class="n">LED_TYPE_MANUAL</span><span class="p">,</span>
    <span class="n">LED_TYPE_BLINK</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">led_state</span> <span class="p">{</span>
    <span class="cm">/* LED type */</span>
    <span class="k">enum</span> <span class="n">led_type</span> <span class="n">type</span><span class="p">;</span>
    <span class="cm">/*
       The first byte means opaque and the other 3 bytes are RGB values.
       You can use opaque byte as a led brightness value.
       If the first byte is 0x00, led is switched off.
       Anything else is worked as on. The max value is 0xFF.
    */</span>
    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">color</span><span class="p">;</span>
    <span class="cm">/* Turn on time in milliseconds */</span>
    <span class="kt">int</span> <span class="n">duty_on</span><span class="p">;</span>
    <span class="cm">/* Turn off time in milliseconds */</span>
    <span class="kt">int</span> <span class="n">duty_off</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">led_device</span> <span class="p">{</span>
    <span class="k">struct</span> <span class="n">hw_common</span> <span class="n">common</span><span class="p">;</span>

    <span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">set_state</span><span class="p">)(</span><span class="k">struct</span> <span class="n">led_state</span> <span class="o">*</span><span class="n">state</span><span class="p">);</span>
<span class="p">};</span>
</code></pre></div></div>

<p>The following table lists the LED HAL functions.</p>

<p><strong>Table: LED HAL functions</strong></p>

<table>
  <thead>
    <tr>
      <th>Function prototype</th>
      <th>Description</th>
      <th>Mandatory</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code class="highlighter-rouge">int (*set_state)(struct led_state *state);</code></td>
      <td>Sets the LED play style and plays LED lights.</td>
      <td>Yes</td>
    </tr>
  </tbody>
</table>

<p>The following code snippet shows an example of the LED HAL:</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#ifndef CAMERA_BACK_PATH
#define CAMERA_BACK_PATH "/sys/class/leds/torch-sec1"
#endif
</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">camera_back_set_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">led_state</span> <span class="o">*</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">static</span> <span class="kt">int</span> <span class="n">max</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">brt</span><span class="p">;</span>
    <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="n">BUF_MAX</span><span class="p">];</span>
    <span class="kt">int</span> <span class="n">fd</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">LED_TYPE_BLINK</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"camera back led does not support LED_TYPE_BLINK mode"</span><span class="p">);</span>

        <span class="k">return</span> <span class="o">-</span><span class="n">ENOTSUP</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">max</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">fd</span> <span class="o">=</span> <span class="n">open</span><span class="p">(</span><span class="n">CAMERA_BACK_PATH</span><span class="s">"/max_brightness"</span><span class="p">,</span> <span class="n">O_RDONLY</span><span class="p">);</span>
        <span class="n">read</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">));</span>
        <span class="n">close</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>
        <span class="n">max</span> <span class="o">=</span> <span class="n">atoi</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="n">brt</span> <span class="o">=</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">color</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">;</span>
    <span class="n">brt</span> <span class="o">=</span> <span class="n">brt</span> <span class="o">/</span> <span class="mf">255.</span><span class="n">f</span> <span class="o">*</span> <span class="n">max</span><span class="p">;</span>

    <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">),</span> <span class="s">"%d"</span><span class="p">,</span> <span class="n">brt</span><span class="p">);</span>
    <span class="n">fd</span> <span class="o">=</span> <span class="n">open</span><span class="p">(</span><span class="n">CAMERA_BACK_PATH</span><span class="s">"/brightness"</span><span class="p">,</span> <span class="n">O_WRONLY</span><span class="p">);</span>
    <span class="n">write</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">buf</span><span class="p">));</span>
    <span class="n">close</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">led_device</span> <span class="n">camera_back_dev</span> <span class="o">=</span> <span class="p">{</span>
    <span class="p">.</span><span class="n">set_state</span> <span class="o">=</span> <span class="n">camera_back_set_state</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">led_device_list</span> <span class="p">{</span>
    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">id</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">led_device</span> <span class="o">*</span><span class="n">operations</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">led_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
<span class="p">}</span> <span class="n">led_list</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
    <span class="p">{</span><span class="n">LED_ID_CAMERA_BACK</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">camera_back_dev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">},</span>
    <span class="p">{</span><span class="n">LED_ID_CAMERA_FRONT</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">},</span>
    <span class="p">{</span><span class="n">LED_ID_NOTIFICATION</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">},</span>
    <span class="p">{</span><span class="n">LED_ID_TOUCH_KEY</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">led_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">hw_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">id</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hw_common</span> <span class="o">**</span><span class="n">common</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">list_len</span><span class="p">,</span> <span class="n">id_len</span><span class="p">;</span>

    <span class="n">list_len</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">led_list</span><span class="p">);</span>
    <span class="n">id_len</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">id</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">list_len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="n">led_list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">id</span><span class="p">,</span> <span class="n">id_len</span><span class="p">))</span>
            <span class="k">continue</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">led_list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">operations</span><span class="p">)</span>
            <span class="k">return</span> <span class="o">-</span><span class="n">ENOTSUP</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">led_list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">dev</span><span class="p">)</span>
            <span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
        <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="n">list_len</span><span class="p">)</span>
        <span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
    <span class="n">led_list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">dev</span> <span class="o">=</span> <span class="n">calloc</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">led_device</span><span class="p">));</span>

    <span class="n">led_list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">common</span><span class="p">.</span><span class="n">info</span> <span class="o">=</span> <span class="n">info</span><span class="p">;</span>
    <span class="n">led_list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">set_state</span>
        <span class="o">=</span> <span class="n">led_list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">operations</span><span class="o">-&gt;</span><span class="n">set_state</span><span class="p">;</span>

<span class="nl">out:</span>
    <span class="o">*</span><span class="n">common</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">hw_common</span> <span class="o">*</span><span class="p">)</span><span class="n">led_list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">dev</span><span class="p">;</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">led_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">hw_common</span> <span class="o">*</span><span class="n">common</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">free</span><span class="p">(</span><span class="n">common</span><span class="p">);</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">HARDWARE_MODULE_STRUCTURE</span> <span class="o">=</span> <span class="p">{</span>
    <span class="p">.</span><span class="n">magic</span> <span class="o">=</span> <span class="n">HARDWARE_INFO_TAG</span><span class="p">,</span>
    <span class="p">.</span><span class="n">hal_version</span> <span class="o">=</span> <span class="n">HARDWARE_INFO_VERSION</span><span class="p">,</span>
    <span class="p">.</span><span class="n">device_version</span> <span class="o">=</span> <span class="n">LED_HARDWARE_DEVICE_VERSION</span><span class="p">,</span>
    <span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">LED_HARDWARE_DEVICE_ID</span><span class="p">,</span>
    <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">"Default LED"</span><span class="p">,</span>
    <span class="p">.</span><span class="n">open</span> <span class="o">=</span> <span class="n">led_open</span><span class="p">,</span>
    <span class="p">.</span><span class="n">close</span> <span class="o">=</span> <span class="n">led_close</span><span class="p">,</span>
<span class="p">};</span>
</code></pre></div></div>

<h4 id="ir-hal">IR HAL</h4>

<p>The IR HAL provides functions for controlling IR transmission. The HAL interface is defined in the <code class="highlighter-rouge">hw/ir.h</code> header file of the <code class="highlighter-rouge">libdevice-node</code> library, and the <code class="highlighter-rouge">pkg-config</code> <code class="highlighter-rouge">device-node</code> must be used to use the HAL interface.</p>

<p>The following code snippet shows the interface of the IR HAL:</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/*
   Device ID
*/</span>
<span class="cp">#define IR_HARDWARE_DEVICE_ID "ir"
</span>
<span class="cm">/*
   Device version
*/</span>
<span class="cp">#define IR_HARDWARE_DEVICE_VERSION MAKE_VERSION(0,1)
</span>
<span class="k">struct</span> <span class="n">ir_device</span> <span class="p">{</span>
    <span class="k">struct</span> <span class="n">hw_common</span> <span class="n">common</span><span class="p">;</span>

    <span class="cm">/* Control the IR state */</span>
    <span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">is_available</span><span class="p">)(</span><span class="kt">bool</span> <span class="o">*</span><span class="n">available</span><span class="p">);</span>
    <span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">transmit</span><span class="p">)(</span><span class="kt">int</span> <span class="o">*</span><span class="n">frequency_pattern</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span><span class="p">);</span>
<span class="p">};</span>
</code></pre></div></div>

<p>The following table lists the IR HAL functions.</p>

<p><strong>Table: IR HAL functions</strong></p>

<table>
  <thead>
    <tr>
      <th>Function prototype</th>
      <th>Description</th>
      <th>Mandatory</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code class="highlighter-rouge">int (*is_available)(bool *available);</code></td>
      <td>Returns whether the target device supports IR transmission.</td>
      <td>Yes</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">int (*transmit)(int *frequency_pattern, int size);</code></td>
      <td>Transmits IR with frequency pattern and its size.</td>
      <td>Yes</td>
    </tr>
  </tbody>
</table>

<p>The following code snippet shows an example of the IR HAL:</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#define IRLED_CONTROL_PATH "/sys/class/ir/ir_send"
</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">ir_is_available</span><span class="p">(</span><span class="kt">bool</span> <span class="o">*</span><span class="n">available</span><span class="p">)</span> <span class="p">{</span>
    <span class="o">*</span><span class="n">available</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">ir_transmit</span><span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="n">frequency_pattern</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>

    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">size</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">),</span> <span class="s">"%d"</span><span class="p">,</span> <span class="n">frequency_pattern</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
        <span class="n">fd</span> <span class="o">=</span> <span class="n">open</span><span class="p">(</span><span class="n">IRLED_CONTROL_PATH</span><span class="p">,</span> <span class="n">O_WRONLY</span><span class="p">);</span>
        <span class="n">write</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">buf</span><span class="p">));</span>
        <span class="n">close</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">ir_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">hw_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">id</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hw_common</span> <span class="o">**</span><span class="n">common</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">struct</span> <span class="n">ir_device</span> <span class="o">*</span><span class="n">ir_dev</span><span class="p">;</span>

    <span class="n">ir_dev</span> <span class="o">=</span> <span class="n">calloc</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ir_device</span><span class="p">));</span>

    <span class="n">ir_dev</span><span class="o">-&gt;</span><span class="n">common</span><span class="p">.</span><span class="n">info</span> <span class="o">=</span> <span class="n">info</span><span class="p">;</span>
    <span class="n">ir_dev</span><span class="o">-&gt;</span><span class="n">is_available</span> <span class="o">=</span> <span class="n">ir_is_available</span><span class="p">;</span>
    <span class="n">ir_dev</span><span class="o">-&gt;</span><span class="n">transmit</span> <span class="o">=</span> <span class="n">ir_transmit</span><span class="p">;</span>

    <span class="o">*</span><span class="n">common</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">hw_common</span> <span class="o">*</span><span class="p">)</span><span class="n">ir_dev</span><span class="p">;</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">ir_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">hw_common</span> <span class="o">*</span><span class="n">common</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">free</span><span class="p">(</span><span class="n">common</span><span class="p">);</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">HARDWARE_MODULE_STRUCTURE</span> <span class="o">=</span> <span class="p">{</span>
    <span class="p">.</span><span class="n">magic</span> <span class="o">=</span> <span class="n">HARDWARE_INFO_TAG</span><span class="p">,</span>
    <span class="p">.</span><span class="n">hal_version</span> <span class="o">=</span> <span class="n">HARDWARE_INFO_VERSION</span><span class="p">,</span>
    <span class="p">.</span><span class="n">device_version</span> <span class="o">=</span> <span class="n">IR_HARDWARE_DEVICE_VERSION</span><span class="p">,</span>
    <span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">IR_HARDWARE_DEVICE_ID</span><span class="p">,</span>
    <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">"ir"</span><span class="p">,</span>
    <span class="p">.</span><span class="n">open</span> <span class="o">=</span> <span class="n">ir_open</span><span class="p">,</span>
    <span class="p">.</span><span class="n">close</span> <span class="o">=</span> <span class="n">ir_close</span><span class="p">,</span>
<span class="p">};</span>
</code></pre></div></div>

<h4 id="touchscreen-hal">Touchscreen HAL</h4>

<p>The touchscreen HAL provides functions for switching the touchscreen on and off. The HAL interface is defined in the <code class="highlighter-rouge">hw/touchscreenf.h</code> header file of the <code class="highlighter-rouge">libdevice-node</code> library, and the <code class="highlighter-rouge">pkg-config</code> <code class="highlighter-rouge">device-node</code> must be used to use the HAL interface.</p>

<p>The following code snippet shows the interface of the touchscreen HAL:</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/*
   Device ID
*/</span>
<span class="cp">#define TOUCHSCREEN_HARDWARE_DEVICE_ID "touchscreen"
</span>
<span class="cm">/*
   Device version
*/</span>
<span class="cp">#define TOUCHSCREEN_HARDWARE_DEVICE_VERSION MAKE_VERSION(0,1)
</span>
<span class="k">enum</span> <span class="n">touchscreen_state</span> <span class="p">{</span>
    <span class="n">TOUCHSCREEN_OFF</span><span class="p">,</span> <span class="cm">/* Disable touchscreen */</span>
    <span class="n">TOUCHSCREEN_ON</span><span class="p">,</span> <span class="cm">/* Enable touchscreen */</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">touchscreen_device</span> <span class="p">{</span>
    <span class="k">struct</span> <span class="n">hw_common</span> <span class="n">common</span><span class="p">;</span>

    <span class="cm">/* Control touchscreen state */</span>
    <span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">get_state</span><span class="p">)(</span><span class="k">enum</span> <span class="n">touchscreen_state</span> <span class="o">*</span><span class="n">state</span><span class="p">);</span>
    <span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">set_state</span><span class="p">)(</span><span class="k">enum</span> <span class="n">touchscreen_state</span> <span class="n">state</span><span class="p">);</span>
<span class="p">};</span>
</code></pre></div></div>

<p>The following table lists the touchscreen HAL functions.</p>

<p><strong>Table: Touchscreen HAL functions</strong></p>

<table>
  <thead>
    <tr>
      <th>Function prototype</th>
      <th>Description</th>
      <th>Mandatory</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code class="highlighter-rouge">int (*get_state)(enum touchscreen_state *state);</code></td>
      <td>Returns whether the touchscreen is enabled.</td>
      <td>Yes</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">int (*set_state)(enum touchscreen_state state);</code></td>
      <td>Enables and disables the touchscreen.</td>
      <td>Yes</td>
    </tr>
  </tbody>
</table>

<p>The following code snippet shows an example of the touchscreen HAL:</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#define TURNON_TOUCHSCREEN 1
#define TURNOFF_TOUCHSCREEN 0
#define TOUCHSCREEN_PATH "/sys/class/input/touchscreen/enable"
</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">touchscreen_get_state</span><span class="p">(</span><span class="k">enum</span> <span class="n">touchscreen_state</span> <span class="o">*</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">val</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">fd</span><span class="p">;</span>
    <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="n">BUF_MAX</span><span class="p">];</span>

    <span class="n">fd</span> <span class="o">=</span> <span class="n">open</span><span class="p">(</span><span class="n">TOUCHSCREEN_PATH</span><span class="p">,</span> <span class="n">O_RDONLY</span><span class="p">);</span>
    <span class="n">read</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">));</span>
    <span class="n">close</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>
    <span class="n">val</span> <span class="o">=</span> <span class="n">atoi</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>

    <span class="k">switch</span> <span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">case</span> <span class="n">TURNOFF_TOUCHSCREEN</span><span class="p">:</span>
        <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">TOUCHSCREEN_OFF</span><span class="p">;</span>
        <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">TURNON_TOUCHSCREEN</span><span class="p">:</span>
        <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">TOUCHSCREEN_ON</span><span class="p">;</span>
        <span class="k">break</span><span class="p">;</span>
    <span class="nl">default:</span>
        <span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">touchscreen_set_state</span><span class="p">(</span><span class="k">enum</span> <span class="n">touchscreen_state</span> <span class="n">state</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">val</span><span class="p">;</span>
    <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="n">BUF_MAX</span><span class="p">];</span>

    <span class="k">switch</span> <span class="p">(</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">case</span> <span class="n">TOUCHSCREEN_OFF</span><span class="p">:</span>
        <span class="n">val</span> <span class="o">=</span> <span class="n">TURNOFF_TOUCHSCREEN</span><span class="p">;</span>
        <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">TOUCHSCREEN_ON</span><span class="p">:</span>
        <span class="n">val</span> <span class="o">=</span> <span class="n">TURNON_TOUCHSCREEN</span><span class="p">;</span>
        <span class="k">break</span><span class="p">;</span>
    <span class="nl">default:</span>
        <span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">),</span> <span class="s">"%d"</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
    <span class="n">fd</span> <span class="o">=</span> <span class="n">open</span><span class="p">(</span><span class="n">TOUCHSCREEN_PATH</span><span class="p">,</span> <span class="n">O_WRONLY</span><span class="p">);</span>
    <span class="n">write</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">buf</span><span class="p">));</span>
    <span class="n">close</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>

    <span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">touchscreen_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">hw_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">id</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hw_common</span> <span class="o">**</span><span class="n">common</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">struct</span> <span class="n">touchscreen_device</span> <span class="o">*</span><span class="n">touchscreen_dev</span><span class="p">;</span>

    <span class="n">touchscreen_dev</span> <span class="o">=</span> <span class="n">calloc</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">touchscreen_device</span><span class="p">));</span>

    <span class="n">touchscreen_dev</span><span class="o">-&gt;</span><span class="n">common</span><span class="p">.</span><span class="n">info</span> <span class="o">=</span> <span class="n">info</span><span class="p">;</span>
    <span class="n">touchscreen_dev</span><span class="o">-&gt;</span><span class="n">get_state</span> <span class="o">=</span> <span class="n">touchscreen_get_state</span><span class="p">;</span>
    <span class="n">touchscreen_dev</span><span class="o">-&gt;</span><span class="n">set_state</span> <span class="o">=</span> <span class="n">touchscreen_set_state</span><span class="p">;</span>

    <span class="o">*</span><span class="n">common</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">hw_common</span> <span class="o">*</span><span class="p">)</span><span class="n">touchscreen_dev</span><span class="p">;</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">touchscreen_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">hw_common</span> <span class="o">*</span><span class="n">common</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">free</span><span class="p">(</span><span class="n">common</span><span class="p">);</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">HARDWARE_MODULE_STRUCTURE</span> <span class="o">=</span> <span class="p">{</span>
    <span class="p">.</span><span class="n">magic</span> <span class="o">=</span> <span class="n">HARDWARE_INFO_TAG</span><span class="p">,</span>
    <span class="p">.</span><span class="n">hal_version</span> <span class="o">=</span> <span class="n">HARDWARE_INFO_VERSION</span><span class="p">,</span>
    <span class="p">.</span><span class="n">device_version</span> <span class="o">=</span> <span class="n">TOUCHSCREEN_HARDWARE_DEVICE_VERSION</span><span class="p">,</span>
    <span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">TOUCHSCREEN_HARDWARE_DEVICE_ID</span><span class="p">,</span>
    <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">"touchscreen"</span><span class="p">,</span>
    <span class="p">.</span><span class="n">open</span> <span class="o">=</span> <span class="n">touchscreen_open</span><span class="p">,</span>
    <span class="p">.</span><span class="n">close</span> <span class="o">=</span> <span class="n">touchscreen_close</span><span class="p">,</span>
<span class="p">};</span>
</code></pre></div></div>

<h2 id="sensor-framework">Sensor Framework</h2>

<p>Sensor devices are used widely in mobile devices to enhance the user experience. Most modern mobile operating systems have a framework which manages hardware and virtual sensors on the platform and provides convenient APIs to the application.</p>

<p>Sensors can be classified into hardware and virtual sensors. Tizen supports individual HALs for the following sensors:</p>

<ul>
  <li>Hardware sensors
    <ul>
      <li>Accelerometer</li>
      <li>Geomagnetic sensor</li>
      <li>Gyroscope</li>
      <li>Light sensor</li>
      <li>Proximity sensor</li>
      <li>Pressure sensor</li>
      <li>Ultraviolet sensor</li>
      <li>Temperature sensor</li>
      <li>Humidity sensor</li>
      <li>HRM (Heart Rate Monitor)</li>
      <li>HRM LED green sensor</li>
      <li>HRM LED IR sensor</li>
      <li>HRM LED red sensor</li>
      <li>Uncalibrated geomagnetic sensor</li>
      <li>Uncalibrated gyroscope sensor</li>
      <li>Human pedometer</li>
      <li>Human sleep monitor</li>
      <li>Human sleep detector</li>
      <li>Human stress monitor</li>
    </ul>
  </li>
  <li>Virtual sensors
    <ul>
      <li>Orientation sensor</li>
      <li>Gravity sensor</li>
      <li>Linear acceleration sensor</li>
      <li>Rotation vector sensor</li>
      <li>Gyroscope rotation vector sensor</li>
      <li>Geomagnetic rotation vector sensor</li>
    </ul>
  </li>
</ul>

<p>The sensor framework provides a sensor server for managing sensor HALs and a medium through which client applications are connected to the sensor handler to exchange data.</p>

<p><strong>Figure: Sensor framework architecture</strong></p>

<p><img src="media/678px-tizen-3-sensorfw.png" alt="Sensor framework architecture" /></p>

<p>The sensor HALs retrieve data from sensor hardware and enable client applications to use the data for specific requirements.</p>

<p>The Sensor framework consists of the following components:</p>

<ul>
  <li>
    <p>Sensor client library</p>

    <p>Any application that wants to access the sensor server and communicate with it must use the sensor API library. Using the Sensor API, the application can control sensors and receive sensor events from the sensor server. By using the sensor API, any application or middleware framework can have the sensor client library executing within its own process context.</p>
  </li>
  <li>
    <p>Sensor server</p>

    <p>The sensor server is a daemon which communicates uniquely to multiple sensors (through drivers) in the system and dispatches sensor data or events back to the application. The sensor server is responsible for initializing the sensors during boot, driver configuration, sensor data fetching and delivery, and managing all sensors and clients on the platform.</p>
  </li>
  <li>
    <p>Sensor HAL (Hardware Abstraction Layer)</p>

    <p>The sensor HAL, which is interfaced to the sensor server, is responsible for interacting with the sensor drivers. The HAL processes data from the sensor drivers and communicates it to the server. Hardware sensors must support the HAL. The sensor HAL is implemented as a shared library. The <code class="highlighter-rouge">sensor_loader</code> finds the <code class="highlighter-rouge">hal.so</code> library in the <code class="highlighter-rouge">/usr/lib/sensor/</code> directory, and loads it at boot time.</p>
  </li>
</ul>

<h3 id="porting-the-hal-interface">Porting the HAL Interface</h3>

<p>You can port individual sensors or a sensorhub.</p>

<h4 id="sensor">Sensor</h4>

<p>To port new hardware sensors, the HAL library-inherited <code class="highlighter-rouge">sensor_device</code> interface must be implemented. The HAL header files can be found at <code class="highlighter-rouge">git:sensord/src/hal</code>.</p>

<p>The Tizen HAL sensor types are also defined in the <code class="highlighter-rouge">sensor_hal_types.h</code> header file under the names <code class="highlighter-rouge">SENSOR_DEVICE_...</code>.</p>

<p><strong>Figure: Sensor HAL</strong></p>

<p><img src="media/tizen-3-sensor-fw-hal.png" alt="Sensor HAL" /></p>

<p>The following code snippet shows the interface of the sensor HAL in the <code class="highlighter-rouge">sensor_hal.h</code> header file:</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/*
   Create devices
*/</span>
<span class="k">typedef</span> <span class="kt">void</span> <span class="o">*</span><span class="n">sensor_device_t</span><span class="p">;</span>
<span class="k">typedef</span> <span class="nf">int</span> <span class="p">(</span><span class="o">*</span><span class="n">create_t</span><span class="p">)(</span><span class="n">sensor_device_t</span> <span class="o">**</span><span class="n">devices</span><span class="p">);</span>

<span class="cm">/*
   Sensor device interface
   1 device must be abstracted from 1 device event node
*/</span>
<span class="k">class</span> <span class="nc">sensor_device</span> <span class="p">{</span>
<span class="nl">public:</span>
    <span class="k">virtual</span> <span class="o">~</span><span class="n">sensor_device</span><span class="p">()</span> <span class="p">{}</span>

    <span class="kt">uint32_t</span> <span class="n">get_hal_version</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">SENSOR_HAL_VERSION</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">virtual</span> <span class="kt">int</span> <span class="n">get_poll_fd</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">virtual</span> <span class="kt">int</span> <span class="n">get_sensors</span><span class="p">(</span><span class="k">const</span> <span class="n">sensor_info_t</span> <span class="o">**</span><span class="n">sensors</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="k">virtual</span> <span class="kt">bool</span> <span class="n">enable</span><span class="p">(</span><span class="kt">uint32_t</span> <span class="n">id</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">virtual</span> <span class="kt">bool</span> <span class="n">disable</span><span class="p">(</span><span class="kt">uint32_t</span> <span class="n">id</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="k">virtual</span> <span class="kt">int</span> <span class="n">read_fd</span><span class="p">(</span><span class="kt">uint32_t</span> <span class="o">**</span><span class="n">ids</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">virtual</span> <span class="kt">int</span> <span class="n">get_data</span><span class="p">(</span><span class="kt">uint32_t</span> <span class="n">id</span><span class="p">,</span> <span class="n">sensor_data_t</span> <span class="o">**</span><span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">length</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="k">virtual</span> <span class="kt">bool</span> <span class="n">set_interval</span><span class="p">(</span><span class="kt">uint32_t</span> <span class="n">id</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">val</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">virtual</span> <span class="kt">bool</span> <span class="n">set_batch_latency</span><span class="p">(</span><span class="kt">uint32_t</span> <span class="n">id</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">val</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">virtual</span> <span class="kt">bool</span> <span class="n">set_attribute_int</span><span class="p">(</span><span class="kt">uint32_t</span> <span class="n">id</span><span class="p">,</span> <span class="kt">int32_t</span> <span class="n">attribute</span><span class="p">,</span> <span class="kt">int32_t</span> <span class="n">value</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">virtual</span> <span class="kt">bool</span> <span class="n">set_attribute_str</span><span class="p">(</span><span class="kt">uint32_t</span> <span class="n">id</span><span class="p">,</span> <span class="kt">int32_t</span> <span class="n">attribute</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">value</span><span class="p">,</span> <span class="kt">int</span> <span class="n">value_len</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">virtual</span> <span class="kt">bool</span> <span class="n">flush</span><span class="p">(</span><span class="kt">uint32_t</span> <span class="n">id</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">};</span>
</code></pre></div></div>

<p>The following table describes the functions of the <code class="highlighter-rouge">sensor_device</code> interface.</p>

<p><strong>Table: sensor_device interface functions</strong></p>

<table>
  <thead>
    <tr>
      <th>Prototype</th>
      <th>Description</th>
      <th>Return value</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code class="highlighter-rouge">uint32_t get_hal_version(void)</code></td>
      <td>Returns the HAL version.</td>
      <td>Version</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">int get_poll_fd(void)</code></td>
      <td>Returns the file description to poll events.</td>
      <td><code class="highlighter-rouge">fd</code></td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">int get_sensors(const sensor_info_t **sensors)</code></td>
      <td>Returns the list of supported sensors. See the <code class="highlighter-rouge">sensor_info_t</code> in the <code class="highlighter-rouge">sensor_hal_types.h</code> header file.</td>
      <td>Size</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">bool enable(uint32_t id)</code></td>
      <td>Enables the sensor.</td>
      <td><code class="highlighter-rouge">true</code> on success</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">bool disable(uint32_t id)</code></td>
      <td>Disables the sensor.</td>
      <td><code class="highlighter-rouge">true</code> on success</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">int read_fd(uint32_t **ids)</code></td>
      <td>Returns the sensor device IDs. The sensor framework calls this function when an event is detected from the <code class="highlighter-rouge">poll-fd</code>.</td>
      <td>Size</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">int get_data(uint32_t id, sensor_data_t **data, int *length)</code></td>
      <td>Updates the <code class="highlighter-rouge">sensor_data_t</code> object (data) with details about the sensor, such as accuracy, timestamp, and values. Note that the <code class="highlighter-rouge">sensor_data_t</code> object must be created using the <code class="highlighter-rouge">malloc()</code> function.</td>
      <td>0 on success</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">bool set_interval(uint32_t id, unsigned long val)</code></td>
      <td>Sets the interval.</td>
      <td><code class="highlighter-rouge">true</code> on success</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">bool set_batch_latency(uint32_t id, unsigned long val)</code></td>
      <td>Sets the batch latency.</td>
      <td><code class="highlighter-rouge">true</code> on success</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">bool set_attribute_int(uint32_t id, int32_t attribute, int32_t value)</code></td>
      <td>Sets the <code class="highlighter-rouge">int</code> value to the attribute.</td>
      <td><code class="highlighter-rouge">true</code> on success</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">bool set_attribute_str(uint32_t id, int32_t attribute, char *value, int value_len)</code></td>
      <td>Sets the <code class="highlighter-rouge">string</code> value to the attribute.</td>
      <td><code class="highlighter-rouge">true</code> on success</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">bool flush(uint32_t id)</code></td>
      <td>Flushes the sensor events.</td>
      <td><code class="highlighter-rouge">true</code> on success</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">int (create_t *)(sensor_device_t **devices)</code></td>
      <td>Returns the <code class="highlighter-rouge">sensor_device</code> list. To create the sensor module in <code class="highlighter-rouge">sensord</code>, you must implement this interface.</td>
      <td>Size</td>
    </tr>
  </tbody>
</table>

<p>The following code snippet shows the interface of the sensor HAL types in the <code class="highlighter-rouge">sensor_hal_type.h</code> header file:</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/*
   Sensor Types
   These types are used to control the sensors

   - base unit
     acceleration values : meter per second^2 (m/s^2)
     magnetic values     : micro-Tesla (uT)
     orientation values  : degrees
     gyroscope values    : degree/s
     temperature values  : degrees centigrade
     proximity values    : distance
     light values        : lux
     pressure values     : hectopascal (hPa)
     humidity            : relative humidity (%)
*/</span>
<span class="k">typedef</span> <span class="k">enum</span> <span class="p">{</span>
    <span class="n">SENSOR_DEVICE_UNKNOWN</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span><span class="p">,</span>
    <span class="n">SENSOR_DEVICE_ALL</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">SENSOR_DEVICE_ACCELEROMETER</span><span class="p">,</span>
    <span class="n">SENSOR_DEVICE_GRAVITY</span><span class="p">,</span>
    <span class="n">SENSOR_DEVICE_LINEAR_</span>
    <span class="n">SENSOR_DEVICE_GEOMAGNETIC</span><span class="p">,</span>
    <span class="n">SENSOR_DEVICE_ROTATION_VECTOR</span><span class="p">,</span>
    <span class="n">SENSOR_DEVICE_ORIENTATION</span><span class="p">,</span>
    <span class="n">SENSOR_DEVICE_GYROSCOPE</span><span class="p">,</span>
    <span class="n">SENSOR_DEVICE_LIGHT</span><span class="p">,</span>
    <span class="n">SENSOR_DEVICE_PROXIMITY</span><span class="p">,</span>
    <span class="n">SENSOR_DEVICE_PRESSURE</span><span class="p">,</span>
    <span class="n">SENSOR_DEVICE_ULTRAVIOLET</span><span class="p">,</span>
    <span class="n">SENSOR_DEVICE_TEMPERATURE</span><span class="p">,</span>
    <span class="n">SENSOR_DEVICE_HUMIDITY</span><span class="p">,</span>
    <span class="n">SENSOR_DEVICE_HRM</span><span class="p">,</span>
    <span class="n">SENSOR_DEVICE_HRM_LED_GREEN</span><span class="p">,</span>
    <span class="n">SENSOR_DEVICE_HRM_LED_IR</span><span class="p">,</span>
    <span class="n">SENSOR_DEVICE_HRM_LED_RED</span><span class="p">,</span>
    <span class="n">SENSOR_DEVICE_GYROSCOPE_UNCAL</span><span class="p">,</span>
    <span class="n">SENSOR_DEVICE_GEOMAGNETIC_UNCAL</span><span class="p">,</span>
    <span class="n">SENSOR_DEVICE_GYROSCOPE_RV</span><span class="p">,</span>
    <span class="n">SENSOR_DEVICE_GEOMAGNETIC_RV</span><span class="p">,</span>

    <span class="n">SENSOR_DEVICE_HUMAN_PEDOMETER</span> <span class="o">=</span> <span class="mh">0x300</span><span class="p">,</span>
    <span class="n">SENSOR_DEVICE_HUMAN_SLEEP_MONITOR</span><span class="p">,</span>
    <span class="n">SENSOR_DEVICE_HUMAN_SLEEP_DETECTOR</span><span class="p">,</span>
    <span class="n">SENSOR_DEVICE_HUMAN_STRESS_MONITOR</span><span class="p">,</span>

    <span class="n">SENSOR_DEVICE_EXERCISE_WALKING</span> <span class="o">=</span> <span class="mh">0x400</span><span class="p">,</span>
    <span class="n">SENSOR_DEVICE_EXERCISE_RUNNING</span><span class="p">,</span>
    <span class="n">SENSOR_DEVICE_EXERCISE_HIKING</span><span class="p">,</span>
    <span class="n">SENSOR_DEVICE_EXERCISE_CYCLING</span><span class="p">,</span>
    <span class="n">SENSOR_DEVICE_EXERCISE_ELLIPTICAL</span><span class="p">,</span>
    <span class="n">SENSOR_DEVICE_EXERCISE_INDOOR_CYCLING</span><span class="p">,</span>
    <span class="n">SENSOR_DEVICE_EXERCISE_ROWING</span><span class="p">,</span>
    <span class="n">SENSOR_DEVICE_EXERCISE_STEPPER</span><span class="p">,</span>

    <span class="n">SENSOR_DEVICE_FUSION</span> <span class="o">=</span> <span class="mh">0x900</span><span class="p">,</span>
    <span class="n">SENSOR_DEVICE_AUTO_ROTATION</span><span class="p">,</span>
    <span class="n">SENSOR_DEVICE_AUTO_BRIGHTNESS</span><span class="p">,</span>

    <span class="n">SENSOR_DEVICE_GESTURE_MOVEMENT</span> <span class="o">=</span> <span class="mh">0x1200</span><span class="p">,</span>
    <span class="n">SENSOR_DEVICE_GESTURE_WRIST_UP</span><span class="p">,</span>
    <span class="n">SENSOR_DEVICE_GESTURE_WRIST_</span>
    <span class="n">SENSOR_DEVICE_GESTURE_MOVEMENT_STATE</span><span class="p">,</span>

    <span class="n">SENSOR_DEVICE_ACTIVITY_TRACKER</span> <span class="o">=</span> <span class="mh">0x1A00</span><span class="p">,</span>
    <span class="n">SENSOR_DEVICE_ACTIVITY_LEVEL_MONITOR</span><span class="p">,</span>
<span class="p">}</span> <span class="n">sensor_device_type</span><span class="p">;</span>
</code></pre></div></div>

<p>The following code snippet shows the interface of the sensor HAL information in the <code class="highlighter-rouge">sensor_hal_type.h</code> header file:</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/*
   A platform sensor handler is generated based on this handle
   This ID can be assigned by HAL developer, so it must be unique in 1 sensor_device.
*/</span>
<span class="k">typedef</span> <span class="k">struct</span> <span class="n">sensor_info_t</span> <span class="p">{</span>
    <span class="kt">uint32_t</span>
    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>
    <span class="n">sensor_device_type</span> <span class="n">type</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">event_type</span><span class="p">;</span> <span class="cm">/* for Internal API */</span>
    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">model_name</span><span class="p">;</span>
    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">vendor</span><span class="p">;</span>
    <span class="kt">float</span> <span class="n">min_range</span><span class="p">;</span>
    <span class="kt">float</span> <span class="n">max_range</span><span class="p">;</span>
    <span class="kt">float</span> <span class="n">resolution</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">min_interval</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">max_batch_count</span><span class="p">;</span>
    <span class="kt">bool</span> <span class="n">wakeup_supported</span><span class="p">;</span>
<span class="p">}</span> <span class="n">sensor_info_t</span><span class="p">;</span>

<span class="k">enum</span> <span class="n">sensor_accuracy_t</span> <span class="p">{</span>
    <span class="n">SENSOR_ACCURACY_UNDEFINED</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">SENSOR_ACCURACY_BAD</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">SENSOR_ACCURACY_NORMAL</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
    <span class="n">SENSOR_ACCURACY_GOOD</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
    <span class="n">SENSOR_ACCURACY_VERYGOOD</span> <span class="o">=</span> <span class="mi">3</span>
<span class="p">};</span>

<span class="cp">#define SENSOR_DATA_VALUE_SIZE 16
</span>
<span class="cm">/* sensor_data_t */</span>
<span class="k">typedef</span> <span class="k">struct</span> <span class="n">sensor_data_t</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">accuracy</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">timestamp</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">value_count</span><span class="p">;</span>
    <span class="kt">float</span> <span class="n">values</span><span class="p">[</span><span class="n">SENSOR_DATA_VALUE_SIZE</span><span class="p">];</span>
<span class="p">}</span> <span class="n">sensor_data_t</span><span class="p">;</span>

<span class="cp">#define SENSOR_PEDOMETER_DATA_DIFFS_SIZE	20
</span>
<span class="k">typedef</span> <span class="k">struct</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">accuracy</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">timestamp</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">value_count</span><span class="p">;</span> <span class="cm">/* value_count == 8 */</span>
    <span class="kt">float</span> <span class="n">values</span><span class="p">[</span><span class="n">SENSOR_DATA_VALUE_SIZE</span><span class="p">];</span>
    <span class="cm">/* values = {step count, walk step count, run step count,
	         moving distance, calorie burned, last speed,
	         last stepping frequency (steps per sec),
	         last step status (walking, running, ...)} */</span>
    <span class="cm">/* Additional data attributes (not in sensor_data_t)*/</span>
    <span class="kt">int</span> <span class="n">diffs_count</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">differences</span> <span class="p">{</span>
        <span class="kt">int</span> <span class="n">timestamp</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">steps</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">walk_steps</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">run_steps</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">walk_up_steps</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">walk_down_steps</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">run_up_steps</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">run_down_steps</span><span class="p">;</span>
        <span class="kt">float</span> <span class="n">distance</span><span class="p">;</span>
        <span class="kt">float</span> <span class="n">calories</span><span class="p">;</span>
        <span class="kt">float</span> <span class="n">speed</span><span class="p">;</span>
    <span class="p">}</span> <span class="n">diffs</span><span class="p">[</span><span class="n">SENSOR_PEDOMETER_DATA_DIFFS_SIZE</span><span class="p">];</span>
<span class="p">}</span> <span class="n">sensor_pedometer_data_t</span><span class="p">;</span>

<span class="cp">#define CONVERT_TYPE_ATTR(type, index) ((type) &lt;&lt; 8 | 0x80 | (index))
</span>
<span class="k">enum</span> <span class="n">sensor_attribute</span> <span class="p">{</span>
    <span class="n">SENSOR_ATTR_ACTIVITY</span> <span class="o">=</span> <span class="n">CONVERT_TYPE_ATTR</span><span class="p">(</span><span class="n">SENSOR_DEVICE_ACTIVITY_TRACKER</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="n">sensor_activity</span> <span class="p">{</span>
    <span class="n">SENSOR_ACTIVITY_UNKNOWN</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
    <span class="n">SENSOR_ACTIVITY_STILL</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
    <span class="n">SENSOR_ACTIVITY_WALKING</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
    <span class="n">SENSOR_ACTIVITY_RUNNING</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
    <span class="n">SENSOR_ACTIVITY_IN_VEHICLE</span> <span class="o">=</span> <span class="mi">16</span><span class="p">,</span>
    <span class="n">SENSOR_ACTIVITY_ON_BICYCLE</span> <span class="o">=</span> <span class="mi">32</span><span class="p">,</span>
<span class="p">};</span>
</code></pre></div></div>

<p>The following code snippet shows an example of the <code class="highlighter-rouge">sensor_device</code> implementation for the accelerometer (<code class="highlighter-rouge">sensor-hal-tm1/src/</code>):</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/* In create.cpp */</span>
<span class="cp">#include &lt;sensor/sensor_hal.h&gt;
#include &lt;sensor_log.h&gt;
#include &lt;vector&gt;
</span>
<span class="cp">#include "accel/accel_device.h"
</span>
<span class="k">static</span> <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">sensor_device_t</span><span class="o">&gt;</span> <span class="n">devs</span><span class="p">;</span>

<span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">_sensor</span><span class="o">&gt;</span>
<span class="kt">void</span>
<span class="nf">create_sensor</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">sensor_device</span> <span class="o">*</span><span class="n">instance</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="k">try</span> <span class="p">{</span>
        <span class="n">instance</span> <span class="o">=</span> <span class="k">new</span> <span class="n">_sensor</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">exception</span> <span class="o">&amp;</span><span class="n">e</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">ERR</span><span class="p">(</span><span class="s">"Failed to create %s sensor device, exception: %s"</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">e</span><span class="p">.</span><span class="n">what</span><span class="p">());</span>

        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="kt">int</span> <span class="n">err</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">_ERRNO</span><span class="p">(</span><span class="n">err</span><span class="p">,</span> <span class="n">_E</span><span class="p">,</span> <span class="s">"Failed to create %s sensor device"</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>

        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">devs</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">instance</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">extern</span> <span class="s">"C"</span> <span class="kt">int</span> <span class="nf">create</span><span class="p">(</span><span class="n">sensor_device_t</span> <span class="o">**</span><span class="n">devices</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifdef ENABLE_ACCEL
</span>    <span class="n">create_sensor</span><span class="o">&lt;</span><span class="n">accel_device</span><span class="o">&gt;</span><span class="p">(</span><span class="s">"Accelerometer"</span><span class="p">);</span>
<span class="cp">#endif
</span>
    <span class="o">*</span><span class="n">devices</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">devs</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

    <span class="k">return</span> <span class="n">devs</span><span class="p">.</span><span class="n">size</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div></div>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/* In accel_device.h */</span>
<span class="cp">#ifndef _ACCEL_DEVICE_H_
#define _ACCEL_DEVICE_H_
</span>
<span class="cp">#include &lt;sensor/sensor_hal.h&gt;
#include &lt;string&gt;
#include &lt;vector&gt;
#include &lt;functional&gt;
</span>
<span class="k">class</span> <span class="nc">accel_device</span> <span class="o">:</span> <span class="k">public</span> <span class="n">sensor_device</span> <span class="p">{</span>
<span class="nl">public:</span>
    <span class="n">accel_device</span><span class="p">();</span>
    <span class="k">virtual</span> <span class="o">~</span><span class="n">accel_device</span><span class="p">();</span>

    <span class="kt">int</span> <span class="n">get_poll_fd</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
    <span class="kt">int</span> <span class="n">get_sensors</span><span class="p">(</span><span class="k">const</span> <span class="n">sensor_info_t</span> <span class="o">**</span><span class="n">sensors</span><span class="p">);</span>

    <span class="kt">bool</span> <span class="n">enable</span><span class="p">(</span><span class="kt">uint32_t</span> <span class="n">id</span><span class="p">);</span>
    <span class="kt">bool</span> <span class="n">disable</span><span class="p">(</span><span class="kt">uint32_t</span> <span class="n">id</span><span class="p">);</span>

    <span class="kt">bool</span> <span class="n">set_interval</span><span class="p">(</span><span class="kt">uint32_t</span> <span class="n">id</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">val</span><span class="p">);</span>

    <span class="kt">int</span> <span class="n">read_fd</span><span class="p">(</span><span class="kt">uint32_t</span> <span class="o">**</span><span class="n">ids</span><span class="p">);</span>
    <span class="kt">int</span> <span class="n">get_data</span><span class="p">(</span><span class="kt">uint32_t</span> <span class="n">id</span><span class="p">,</span> <span class="n">sensor_data_t</span> <span class="o">**</span><span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">length</span><span class="p">);</span>

<span class="nl">private:</span>
    <span class="kt">int</span> <span class="n">m_node_handle</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">m_x</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">m_y</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">m_z</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">m_polling_interval</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">m_fired_time</span><span class="p">;</span>
    <span class="kt">bool</span> <span class="n">m_sensorhub_controlled</span><span class="p">;</span>

    <span class="kt">int</span> <span class="n">m_method</span><span class="p">;</span>
    <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">m_data_node</span><span class="p">;</span>
    <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">m_enable_node</span><span class="p">;</span>
    <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">m_interval_node</span><span class="p">;</span>

    <span class="n">std</span><span class="o">::</span><span class="n">function</span><span class="o">&lt;</span><span class="kt">bool</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="o">&gt;</span> <span class="n">update_value</span><span class="p">;</span>

    <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">uint32_t</span><span class="o">&gt;</span> <span class="n">event_ids</span><span class="p">;</span>

    <span class="kt">bool</span> <span class="n">update_value_input_event</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
    <span class="kt">bool</span> <span class="n">update_value_iio</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>

    <span class="kt">void</span> <span class="n">raw_to_base</span><span class="p">(</span><span class="n">sensor_data_t</span> <span class="o">*</span><span class="n">data</span><span class="p">);</span>
<span class="p">};</span>
<span class="cp">#endif </span><span class="cm">/* _ACCEL_DEVICE_H_ */</span><span class="cp">
</span></code></pre></div></div>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/* In accel_device.cpp */</span>
<span class="cp">#include &lt;fcntl.h&gt;
#include &lt;unistd.h&gt;
#include &lt;sys/types.h&gt;
#include &lt;sys/stat.h&gt;
</span>
<span class="cp">#include &lt;linux/input.h&gt;
#include &lt;sys/ioctl.h&gt;
#include &lt;poll.h&gt;
</span>
<span class="cp">#include &lt;util.h&gt;
#include &lt;sensor_common.h&gt;
#include &lt;sensor_log.h&gt;
</span>
<span class="cp">#include "accel_device.h"
</span>
<span class="cp">#define MODEL_NAME "K2HH"
#define VENDOR "ST Microelectronics"
#define RESOLUTION 16
#define RAW_DATA_UNIT 0.122
#define MIN_INTERVAL 1
#define MAX_BATCH_COUNT 0
</span>
<span class="cp">#define SENSOR_NAME "SENSOR_ACCELEROMETER"
#define SENSOR_TYPE_ACCEL		"ACCEL"
</span>
<span class="cp">#define INPUT_NAME	"accelerometer_sensor"
#define ACCEL_SENSORHUB_POLL_NODE_NAME "accel_poll_delay"
</span>
<span class="cp">#define GRAVITY 9.80665
#define G_TO_MG 1000
#define RAW_DATA_TO_G_UNIT(X) (((float)(X))/((float)G_TO_MG))
#define RAW_DATA_TO_METRE_PER_SECOND_SQUARED_UNIT(X) (GRAVITY * (RAW_DATA_TO_G_UNIT(X)))
</span>
<span class="cp">#define MIN_RANGE(RES) (-((1 &lt;&lt; (RES))/2))
#define MAX_RANGE(RES) (((1 &lt;&lt; (RES))/2)-1)
</span>
<span class="k">static</span> <span class="n">sensor_info_t</span> <span class="n">sensor_info</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nl">id:</span> <span class="mh">0x1</span><span class="p">,</span>
    <span class="nl">name:</span> <span class="n">SENSOR_NAME</span><span class="p">,</span>
    <span class="nl">type:</span> <span class="n">SENSOR_DEVICE_ACCELEROMETER</span><span class="p">,</span>
    <span class="nl">event_type:</span> <span class="p">(</span><span class="n">SENSOR_DEVICE_ACCELEROMETER</span> <span class="o">&lt;&lt;</span> <span class="n">SENSOR_EVENT_SHIFT</span><span class="p">)</span> <span class="o">|</span> <span class="n">RAW_DATA_EVENT</span><span class="p">,</span>
    <span class="nl">model_name:</span> <span class="n">MODEL_NAME</span><span class="p">,</span>
    <span class="nl">vendor:</span> <span class="n">VENDOR</span><span class="p">,</span>
    <span class="nl">min_range:</span> <span class="n">MIN_RANGE</span><span class="p">(</span><span class="n">RESOLUTION</span><span class="p">)</span> <span class="o">*</span> <span class="n">RAW_DATA_TO_METRE_PER_SECOND_SQUARED_UNIT</span><span class="p">(</span><span class="n">RAW_DATA_UNIT</span><span class="p">),</span>
    <span class="nl">max_range:</span> <span class="n">MAX_RANGE</span><span class="p">(</span><span class="n">RESOLUTION</span><span class="p">)</span> <span class="o">*</span> <span class="n">RAW_DATA_TO_METRE_PER_SECOND_SQUARED_UNIT</span><span class="p">(</span><span class="n">RAW_DATA_UNIT</span><span class="p">),</span>
    <span class="nl">resolution:</span> <span class="n">RAW_DATA_TO_METRE_PER_SECOND_SQUARED_UNIT</span><span class="p">(</span><span class="n">RAW_DATA_UNIT</span><span class="p">),</span>
    <span class="nl">min_interval:</span> <span class="n">MIN_INTERVAL</span><span class="p">,</span>
    <span class="nl">max_batch_count:</span> <span class="n">MAX_BATCH_COUNT</span><span class="p">,</span>
    <span class="nl">wakeup_supported:</span> <span class="nb">false</span>
<span class="p">};</span>

<span class="n">accel_device</span><span class="o">::</span><span class="n">accel_device</span><span class="p">()</span>
<span class="o">:</span> <span class="n">m_node_handle</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<span class="p">,</span> <span class="n">m_x</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<span class="p">,</span> <span class="n">m_y</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<span class="p">,</span> <span class="n">m_z</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<span class="p">,</span> <span class="n">m_polling_interval</span><span class="p">(</span><span class="mi">1000</span><span class="p">)</span>
<span class="p">,</span> <span class="n">m_fired_time</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="p">,</span> <span class="n">m_sensorhub_controlled</span><span class="p">(</span><span class="nb">false</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">sensorhub_interval_node_name</span> <span class="o">=</span> <span class="n">ACCEL_SENSORHUB_POLL_NODE_NAME</span><span class="p">;</span>

    <span class="n">node_info_query</span> <span class="n">query</span><span class="p">;</span>
    <span class="n">node_info</span> <span class="n">info</span><span class="p">;</span>

    <span class="n">query</span><span class="p">.</span><span class="n">sensorhub_controlled</span> <span class="o">=</span> <span class="n">m_sensorhub_controlled</span> <span class="o">=</span> <span class="n">util</span><span class="o">::</span><span class="n">is_sensorhub_controlled</span><span class="p">(</span><span class="n">sensorhub_interval_node_name</span><span class="p">);</span>
    <span class="n">query</span><span class="p">.</span><span class="n">sensor_type</span> <span class="o">=</span> <span class="n">SENSOR_TYPE_ACCEL</span><span class="p">;</span>
    <span class="n">query</span><span class="p">.</span><span class="n">key</span> <span class="o">=</span> <span class="n">INPUT_NAME</span><span class="p">;</span>
    <span class="n">query</span><span class="p">.</span><span class="n">iio_enable_node_name</span> <span class="o">=</span> <span class="s">"accel_enable"</span><span class="p">;</span>
    <span class="n">query</span><span class="p">.</span><span class="n">sensorhub_interval_node_name</span> <span class="o">=</span> <span class="n">sensorhub_interval_node_name</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">util</span><span class="o">::</span><span class="n">get_node_info</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">info</span><span class="p">))</span> <span class="p">{</span>
        <span class="n">_E</span><span class="p">(</span><span class="s">"Failed to get node info"</span><span class="p">);</span>
        <span class="k">throw</span> <span class="n">ENXIO</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">util</span><span class="o">::</span><span class="n">show_node_info</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>

    <span class="n">m_method</span> <span class="o">=</span> <span class="n">info</span><span class="p">.</span><span class="n">method</span><span class="p">;</span>
    <span class="n">m_data_node</span> <span class="o">=</span> <span class="n">info</span><span class="p">.</span><span class="n">data_node_path</span><span class="p">;</span>
    <span class="n">m_enable_node</span> <span class="o">=</span> <span class="n">info</span><span class="p">.</span><span class="n">enable_node_path</span><span class="p">;</span>
    <span class="n">m_interval_node</span> <span class="o">=</span> <span class="n">info</span><span class="p">.</span><span class="n">interval_node_path</span><span class="p">;</span>

    <span class="n">m_node_handle</span> <span class="o">=</span> <span class="n">open</span><span class="p">(</span><span class="n">m_data_node</span><span class="p">.</span><span class="n">c_str</span><span class="p">(),</span> <span class="n">O_RDONLY</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">m_node_handle</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">_ERRNO</span><span class="p">(</span><span class="n">errno</span><span class="p">,</span> <span class="n">_E</span><span class="p">,</span> <span class="s">"accel handle open fail for accel processor"</span><span class="p">);</span>
        <span class="k">throw</span> <span class="n">ENXIO</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">m_method</span> <span class="o">==</span> <span class="n">INPUT_EVENT_METHOD</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">util</span><span class="o">::</span><span class="n">set_monotonic_clock</span><span class="p">(</span><span class="n">m_node_handle</span><span class="p">))</span>
            <span class="k">throw</span> <span class="n">ENXIO</span><span class="p">;</span>

        <span class="n">update_value</span> <span class="o">=</span> <span class="p">[</span><span class="o">=</span><span class="p">]()</span> <span class="p">{</span>
            <span class="k">return</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">update_value_input_event</span><span class="p">();</span>
        <span class="p">};</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="p">.</span><span class="n">buffer_length_node_path</span><span class="p">.</span><span class="n">empty</span><span class="p">())</span>
            <span class="n">util</span><span class="o">::</span><span class="n">set_node_value</span><span class="p">(</span><span class="n">info</span><span class="p">.</span><span class="n">buffer_length_node_path</span><span class="p">,</span> <span class="mi">480</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="p">.</span><span class="n">buffer_enable_node_path</span><span class="p">.</span><span class="n">empty</span><span class="p">())</span>
            <span class="n">util</span><span class="o">::</span><span class="n">set_node_value</span><span class="p">(</span><span class="n">info</span><span class="p">.</span><span class="n">buffer_enable_node_path</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

        <span class="n">update_value</span> <span class="o">=</span> <span class="p">[</span><span class="o">=</span><span class="p">]()</span> <span class="p">{</span>
            <span class="k">return</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">update_value_iio</span><span class="p">();</span>
        <span class="p">};</span>
    <span class="p">}</span>

    <span class="n">_I</span><span class="p">(</span><span class="s">"accel_device is created!"</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">accel_device</span><span class="o">::~</span><span class="n">accel_device</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">close</span><span class="p">(</span><span class="n">m_node_handle</span><span class="p">);</span>
    <span class="n">m_node_handle</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

    <span class="n">_I</span><span class="p">(</span><span class="s">"accel_device is destroyed!"</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="n">accel_device</span><span class="o">::</span><span class="n">get_poll_fd</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">m_node_handle</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="n">accel_device</span><span class="o">::</span><span class="n">get_sensors</span><span class="p">(</span><span class="k">const</span> <span class="n">sensor_info_t</span> <span class="o">**</span><span class="n">sensors</span><span class="p">)</span> <span class="p">{</span>
    <span class="o">*</span><span class="n">sensors</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sensor_info</span><span class="p">;</span>

    <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">bool</span>
<span class="n">accel_device</span><span class="o">::</span><span class="n">enable</span><span class="p">(</span><span class="kt">uint32_t</span> <span class="n">id</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">util</span><span class="o">::</span><span class="n">set_enable_node</span><span class="p">(</span><span class="n">m_enable_node</span><span class="p">,</span> <span class="n">m_sensorhub_controlled</span><span class="p">,</span> <span class="nb">true</span><span class="p">,</span> <span class="n">SENSORHUB_ACCELEROMETER_ENABLE_BIT</span><span class="p">);</span>
    <span class="n">set_interval</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="n">m_polling_interval</span><span class="p">);</span>

    <span class="n">m_fired_time</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">_I</span><span class="p">(</span><span class="s">"Enable accelerometer sensor"</span><span class="p">);</span>

    <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">bool</span>
<span class="n">accel_device</span><span class="o">::</span><span class="n">disable</span><span class="p">(</span><span class="kt">uint32_t</span> <span class="n">id</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">util</span><span class="o">::</span><span class="n">set_enable_node</span><span class="p">(</span><span class="n">m_enable_node</span><span class="p">,</span> <span class="n">m_sensorhub_controlled</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span> <span class="n">SENSORHUB_ACCELEROMETER_ENABLE_BIT</span><span class="p">);</span>

    <span class="n">_I</span><span class="p">(</span><span class="s">"Disable accelerometer sensor"</span><span class="p">);</span>

    <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">bool</span>
<span class="n">accel_device</span><span class="o">::</span><span class="n">set_interval</span><span class="p">(</span><span class="kt">uint32_t</span> <span class="n">id</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">val</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">polling_interval_ns</span><span class="p">;</span>

    <span class="n">polling_interval_ns</span> <span class="o">=</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)(</span><span class="n">val</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1000llu</span> <span class="o">*</span> <span class="mi">1000llu</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">util</span><span class="o">::</span><span class="n">set_node_value</span><span class="p">(</span><span class="n">m_interval_node</span><span class="p">,</span> <span class="n">polling_interval_ns</span><span class="p">))</span> <span class="p">{</span>
        <span class="n">_E</span><span class="p">(</span><span class="s">"Failed to set polling resource: %s"</span><span class="p">,</span> <span class="n">m_interval_node</span><span class="p">.</span><span class="n">c_str</span><span class="p">());</span>

        <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">_I</span><span class="p">(</span><span class="s">"Interval is changed from %dms to %dms"</span><span class="p">,</span> <span class="n">m_polling_interval</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
    <span class="n">m_polling_interval</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>

    <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">bool</span>
<span class="n">accel_device</span><span class="o">::</span><span class="n">update_value_input_event</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">accel_raw</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">,};</span>
    <span class="kt">bool</span> <span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">read_input_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">const</span> <span class="kt">int</span> <span class="n">INPUT_MAX_BEFORE_SYN</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">fired_time</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="kt">bool</span> <span class="n">syn</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

    <span class="n">x</span> <span class="o">=</span> <span class="n">y</span> <span class="o">=</span> <span class="n">z</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

    <span class="k">struct</span> <span class="n">input_event</span> <span class="n">accel_input</span><span class="p">;</span>
    <span class="n">_D</span><span class="p">(</span><span class="s">"accel event detection!"</span><span class="p">);</span>

    <span class="k">while</span> <span class="p">((</span><span class="n">syn</span> <span class="o">==</span> <span class="nb">false</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">read_input_cnt</span> <span class="o">&lt;</span> <span class="n">INPUT_MAX_BEFORE_SYN</span><span class="p">))</span> <span class="p">{</span>
        <span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="n">read</span><span class="p">(</span><span class="n">m_node_handle</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">accel_input</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">accel_input</span><span class="p">));</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">!=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">accel_input</span><span class="p">))</span> <span class="p">{</span>
            <span class="n">_E</span><span class="p">(</span><span class="s">"accel_file read fail, read_len = %d"</span><span class="p">,</span><span class="n">len</span><span class="p">);</span>

            <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="o">++</span><span class="n">read_input_cnt</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">accel_input</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">EV_REL</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">switch</span> <span class="p">(</span><span class="n">accel_input</span><span class="p">.</span><span class="n">code</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">case</span> <span class="n">REL_X</span><span class="p">:</span>
                <span class="n">accel_raw</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">accel_input</span><span class="p">.</span><span class="n">value</span><span class="p">;</span>
                <span class="n">x</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="k">case</span> <span class="n">REL_Y</span><span class="p">:</span>
                <span class="n">accel_raw</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">accel_input</span><span class="p">.</span><span class="n">value</span><span class="p">;</span>
                <span class="n">y</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="k">case</span> <span class="n">REL_Z</span><span class="p">:</span>
                <span class="n">accel_raw</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">accel_input</span><span class="p">.</span><span class="n">value</span><span class="p">;</span>
                <span class="n">z</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="nl">default:</span>
                <span class="n">_E</span><span class="p">(</span><span class="s">"accel_input event[type = %d, code = %d] is unknown."</span><span class="p">,</span> <span class="n">accel_input</span><span class="p">.</span><span class="n">type</span><span class="p">,</span> <span class="n">accel_input</span><span class="p">.</span><span class="n">code</span><span class="p">);</span>

                <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">accel_input</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">EV_SYN</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">syn</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
            <span class="n">fired_time</span> <span class="o">=</span> <span class="n">util</span><span class="o">::</span><span class="n">get_timestamp</span><span class="p">(</span><span class="o">&amp;</span><span class="n">accel_input</span><span class="p">.</span><span class="n">time</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="n">_E</span><span class="p">(</span><span class="s">"accel_input event[type = %d, code = %d] is unknown."</span><span class="p">,</span> <span class="n">accel_input</span><span class="p">.</span><span class="n">type</span><span class="p">,</span> <span class="n">accel_input</span><span class="p">.</span><span class="n">code</span><span class="p">);</span>

            <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">syn</span> <span class="o">==</span> <span class="nb">false</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">_E</span><span class="p">(</span><span class="s">"EV_SYN didn't come until %d inputs had come"</span><span class="p">,</span> <span class="n">read_input_cnt</span><span class="p">);</span>

        <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">m_x</span> <span class="o">=</span>  <span class="n">accel_raw</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">y</span><span class="p">)</span>
        <span class="n">m_y</span> <span class="o">=</span>  <span class="n">accel_raw</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">z</span><span class="p">)</span>
        <span class="n">m_z</span> <span class="o">=</span>  <span class="n">accel_raw</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>

    <span class="n">m_fired_time</span> <span class="o">=</span> <span class="n">fired_time</span><span class="p">;</span>

    <span class="n">_D</span><span class="p">(</span><span class="s">"m_x = %d, m_y = %d, m_z = %d, time = %lluus"</span><span class="p">,</span> <span class="n">m_x</span><span class="p">,</span> <span class="n">m_y</span><span class="p">,</span> <span class="n">m_z</span><span class="p">,</span> <span class="n">m_fired_time</span><span class="p">);</span>

    <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">bool</span>
<span class="n">accel_device</span><span class="o">::</span><span class="n">update_value_iio</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">struct</span> <span class="p">{</span>
        <span class="kt">int16_t</span> <span class="n">x</span><span class="p">;</span>
        <span class="kt">int16_t</span> <span class="n">y</span><span class="p">;</span>
        <span class="kt">int16_t</span> <span class="n">z</span><span class="p">;</span>
        <span class="kt">int64_t</span> <span class="n">timestamp</span><span class="p">;</span>
    <span class="p">}</span> <span class="n">__attribute__</span><span class="p">((</span><span class="n">packed</span><span class="p">))</span> <span class="n">data</span><span class="p">;</span>

    <span class="k">struct</span> <span class="n">pollfd</span> <span class="n">pfd</span><span class="p">;</span>

    <span class="n">pfd</span><span class="p">.</span><span class="n">fd</span> <span class="o">=</span> <span class="n">m_node_handle</span><span class="p">;</span>
    <span class="n">pfd</span><span class="p">.</span><span class="n">events</span> <span class="o">=</span> <span class="n">POLLIN</span> <span class="o">|</span> <span class="n">POLLERR</span><span class="p">;</span>
    <span class="n">pfd</span><span class="p">.</span><span class="n">revents</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">poll</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pfd</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">_ERRNO</span><span class="p">(</span><span class="n">errno</span><span class="p">,</span> <span class="n">_E</span><span class="p">,</span> <span class="s">"Failed to poll from m_node_handle:%d"</span><span class="p">,</span> <span class="n">m_node_handle</span><span class="p">);</span>

        <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">_E</span><span class="p">(</span><span class="s">"poll timeout m_node_handle:%d"</span><span class="p">,</span> <span class="n">m_node_handle</span><span class="p">);</span>

        <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">pfd</span><span class="p">.</span><span class="n">revents</span> <span class="o">&amp;</span> <span class="n">POLLERR</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">_E</span><span class="p">(</span><span class="s">"poll exception occurred! m_node_handle:%d"</span><span class="p">,</span> <span class="n">m_node_handle</span><span class="p">);</span>

        <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">pfd</span><span class="p">.</span><span class="n">revents</span> <span class="o">&amp;</span> <span class="n">POLLIN</span><span class="p">))</span> <span class="p">{</span>
        <span class="n">_E</span><span class="p">(</span><span class="s">"poll nothing to read! m_node_handle:%d, pfd.revents = %d"</span><span class="p">,</span> <span class="n">m_node_handle</span><span class="p">,</span> <span class="n">pfd</span><span class="p">.</span><span class="n">revents</span><span class="p">);</span>

        <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="n">read</span><span class="p">(</span><span class="n">m_node_handle</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">data</span><span class="p">));</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">!=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">data</span><span class="p">))</span> <span class="p">{</span>
        <span class="n">_E</span><span class="p">(</span><span class="s">"Failed to read data, m_node_handle:%d read_len:%d"</span><span class="p">,</span> <span class="n">m_node_handle</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>

        <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">m_x</span> <span class="o">=</span> <span class="n">data</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
    <span class="n">m_y</span> <span class="o">=</span> <span class="n">data</span><span class="p">.</span><span class="n">y</span><span class="p">;</span>
    <span class="n">m_z</span> <span class="o">=</span> <span class="n">data</span><span class="p">.</span><span class="n">z</span><span class="p">;</span>
    <span class="n">m_fired_time</span> <span class="o">=</span> <span class="n">data</span><span class="p">.</span><span class="n">timestamp</span><span class="p">;</span>

    <span class="n">_D</span><span class="p">(</span><span class="s">"m_x = %d, m_y = %d, m_z = %d, time = %lluus"</span><span class="p">,</span> <span class="n">m_x</span><span class="p">,</span> <span class="n">m_y</span><span class="p">,</span> <span class="n">m_z</span><span class="p">,</span> <span class="n">m_fired_time</span><span class="p">);</span>

    <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="n">accel_device</span><span class="o">::</span><span class="n">read_fd</span><span class="p">(</span><span class="kt">uint32_t</span> <span class="o">**</span><span class="n">ids</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">update_value</span><span class="p">())</span> <span class="p">{</span>
        <span class="n">_D</span><span class="p">(</span><span class="s">"Failed to update value"</span><span class="p">);</span>

        <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">event_ids</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span>
    <span class="n">event_ids</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">sensor_info</span><span class="p">.</span><span class="n">id</span><span class="p">);</span>

    <span class="o">*</span><span class="n">ids</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">event_ids</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

    <span class="k">return</span> <span class="n">event_ids</span><span class="p">.</span><span class="n">size</span><span class="p">();</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="n">accel_device</span><span class="o">::</span><span class="n">get_data</span><span class="p">(</span><span class="kt">uint32_t</span> <span class="n">id</span><span class="p">,</span> <span class="n">sensor_data_t</span> <span class="o">**</span><span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">length</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">sensor_data_t</span> <span class="o">*</span><span class="n">sensor_data</span><span class="p">;</span>

    <span class="cm">/* [Important] In HAL, you MUST allocate memory for data.
     * HAL does not need to release this memory because it must be released only after sending this data to clients.
    */</span>
    <span class="n">sensor_data</span> <span class="o">=</span> <span class="p">(</span><span class="n">sensor_data_t</span> <span class="o">*</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">sensor_data_t</span><span class="p">));</span>
    <span class="n">retvm_if</span><span class="p">(</span><span class="o">!</span><span class="n">sensor_data</span><span class="p">,</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">,</span> <span class="s">"Memory allocation failed"</span><span class="p">);</span>

    <span class="n">sensor_data</span><span class="o">-&gt;</span><span class="n">accuracy</span> <span class="o">=</span> <span class="n">SENSOR_ACCURACY_GOOD</span><span class="p">;</span>
    <span class="n">sensor_data</span><span class="o">-&gt;</span><span class="n">timestamp</span> <span class="o">=</span> <span class="n">m_fired_time</span><span class="p">;</span>
    <span class="n">sensor_data</span><span class="o">-&gt;</span><span class="n">value_count</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
    <span class="n">sensor_data</span><span class="o">-&gt;</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">m_x</span><span class="p">;</span>
    <span class="n">sensor_data</span><span class="o">-&gt;</span><span class="n">values</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">m_y</span><span class="p">;</span>
    <span class="n">sensor_data</span><span class="o">-&gt;</span><span class="n">values</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">m_z</span><span class="p">;</span>

    <span class="n">raw_to_base</span><span class="p">(</span><span class="n">sensor_data</span><span class="p">);</span>

    <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">sensor_data</span><span class="p">;</span>
    <span class="o">*</span><span class="n">length</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">sensor_data_t</span><span class="p">);</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="n">accel_device</span><span class="o">::</span><span class="n">raw_to_base</span><span class="p">(</span><span class="n">sensor_data_t</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">data</span><span class="o">-&gt;</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">RAW_DATA_TO_METRE_PER_SECOND_SQUARED_UNIT</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">RAW_DATA_UNIT</span><span class="p">);</span>
    <span class="n">data</span><span class="o">-&gt;</span><span class="n">values</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">RAW_DATA_TO_METRE_PER_SECOND_SQUARED_UNIT</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">values</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">RAW_DATA_UNIT</span><span class="p">);</span>
    <span class="n">data</span><span class="o">-&gt;</span><span class="n">values</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">RAW_DATA_TO_METRE_PER_SECOND_SQUARED_UNIT</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">values</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="n">RAW_DATA_UNIT</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<h4 id="sensorhub">Sensorhub</h4>

<p>The sensorhub HAL supports multiple sensors logically from 1 physical device file. If many sensors are supported by a single device file, the sensorhub HAL can be configured so that it can operate each sensor as a logically-separate device.</p>

<p>The sensor HAL interface is provided to manufacturers and vendors through the <code class="highlighter-rouge">sensor_hal.h</code> and <code class="highlighter-rouge">sensor_hal_types.h</code> header files. It uses just 1 thread for polling sensor events from multiple device files.</p>

<p><strong>Figure: Sensorhub HAL</strong></p>

<p><img src="media/656px-tizen-3-sensorhub2.png" alt="Sensorhub HAL" /></p>

<p>The sensorhub HAL can be developed by using the <code class="highlighter-rouge">sensor_device</code> interface. An example of a sensorhub HAL can be found in the <code class="highlighter-rouge">sensor-hal-tm1/src/sensorhub</code> Git.</p>

<p>IDs can be assigned by the vendor or manufacturer for the sensorhub sensors by using the following <code class="highlighter-rouge">sensor_info_t</code> interface:</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">typedef</span> <span class="k">struct</span> <span class="n">sensor_info_t</span> <span class="p">{</span>
    <span class="kt">uint32_t</span> <span class="n">id</span><span class="p">;</span>
    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>
    <span class="n">sensor_device_type</span> <span class="n">type</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">event_type</span><span class="p">;</span> <span class="cm">/* For Internal API */</span>
    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">model_name</span><span class="p">;</span>
    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">vendor</span><span class="p">;</span>
    <span class="kt">float</span> <span class="n">min_range</span><span class="p">;</span>
    <span class="kt">float</span> <span class="n">max_range</span><span class="p">;</span>
    <span class="kt">float</span> <span class="n">resolution</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">min_interval</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">max_batch_count</span><span class="p">;</span>
    <span class="kt">bool</span> <span class="n">wakeup_supported</span><span class="p">;</span>
<span class="p">}</span> <span class="n">sensor_info_t</span><span class="p">;</span>
</code></pre></div></div>

<p>The following code snippet shows an example of a sensorhub HAL implementation:</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include &lt;algorithm&gt;
#include &lt;sensor_log.h&gt;
</span>
<span class="cp">#include "sensorhub.h"
#include "sensorhub_controller.h"
#include "sensorhub_manager.h"
#include "system_state.h"
</span>
<span class="n">sensorhub_device</span><span class="o">::</span><span class="n">sensorhub_device</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">controller</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sensorhub_controller</span><span class="o">::</span><span class="n">get_instance</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">controller</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">ERR</span><span class="p">(</span><span class="s">"Failed to allocated memory"</span><span class="p">);</span>
        <span class="k">throw</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">manager</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sensorhub_manager</span><span class="o">::</span><span class="n">get_instance</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">manager</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">ERR</span><span class="p">(</span><span class="s">"Failed to allocated memory"</span><span class="p">);</span>
        <span class="k">throw</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">manager</span><span class="o">-&gt;</span><span class="n">set_controller</span><span class="p">(</span><span class="n">controller</span><span class="p">);</span>
    <span class="n">system_state_handler</span><span class="o">::</span><span class="n">get_instance</span><span class="p">().</span><span class="n">set_controller</span><span class="p">(</span><span class="n">controller</span><span class="p">);</span>

    <span class="n">INFO</span><span class="p">(</span><span class="s">"sensorhub_device is created!"</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">sensorhub_device</span><span class="o">::~</span><span class="n">sensorhub_device</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">INFO</span><span class="p">(</span><span class="s">"sensorhub_device is destroyed!"</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="n">sensorhub_device</span><span class="o">::</span><span class="n">get_poll_fd</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">controller</span><span class="o">-&gt;</span><span class="n">get_poll_fd</span><span class="p">();</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="n">sensorhub_device</span><span class="o">::</span><span class="n">get_sensors</span><span class="p">(</span><span class="k">const</span> <span class="n">sensor_info_t</span> <span class="o">**</span><span class="n">sensors</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">size</span><span class="p">;</span>
    <span class="n">size</span> <span class="o">=</span> <span class="n">manager</span><span class="o">-&gt;</span><span class="n">get_sensors</span><span class="p">(</span><span class="n">sensors</span><span class="p">);</span>

    <span class="k">return</span> <span class="n">size</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">bool</span>
<span class="n">sensorhub_device</span><span class="o">::</span><span class="n">enable</span><span class="p">(</span><span class="kt">uint32_t</span> <span class="n">id</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">system_state_handler</span><span class="o">::</span><span class="n">get_instance</span><span class="p">().</span><span class="n">initialize</span><span class="p">();</span>

    <span class="n">controller</span><span class="o">-&gt;</span><span class="n">enable</span><span class="p">();</span>
    <span class="n">sensorhub_sensor</span> <span class="o">*</span><span class="n">sensor</span> <span class="o">=</span> <span class="n">manager</span><span class="o">-&gt;</span><span class="n">get_sensor</span><span class="p">(</span><span class="n">id</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sensor</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">ERR</span><span class="p">(</span><span class="s">"Failed to enable sensor(0x%x)"</span><span class="p">,</span> <span class="n">id</span><span class="p">);</span>

        <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">sensor</span><span class="o">-&gt;</span><span class="n">enable</span><span class="p">();</span>
<span class="p">}</span>

<span class="kt">bool</span>
<span class="n">sensorhub_device</span><span class="o">::</span><span class="n">disable</span><span class="p">(</span><span class="kt">uint32_t</span> <span class="n">id</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">system_state_handler</span><span class="o">::</span><span class="n">get_instance</span><span class="p">().</span><span class="n">finalize</span><span class="p">();</span>

    <span class="n">controller</span><span class="o">-&gt;</span><span class="n">disable</span><span class="p">();</span>
    <span class="n">sensorhub_sensor</span> <span class="o">*</span><span class="n">sensor</span> <span class="o">=</span> <span class="n">manager</span><span class="o">-&gt;</span><span class="n">get_sensor</span><span class="p">(</span><span class="n">id</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sensor</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">ERR</span><span class="p">(</span><span class="s">"Failed to disable sensor(0x%x)"</span><span class="p">,</span> <span class="n">id</span><span class="p">);</span>

        <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">sensor</span><span class="o">-&gt;</span><span class="n">disable</span><span class="p">();</span>
<span class="p">}</span>

<span class="kt">bool</span>
<span class="n">sensorhub_device</span><span class="o">::</span><span class="n">set_interval</span><span class="p">(</span><span class="kt">uint32_t</span> <span class="n">id</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">val</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">sensorhub_sensor</span> <span class="o">*</span><span class="n">sensor</span> <span class="o">=</span> <span class="n">manager</span><span class="o">-&gt;</span><span class="n">get_sensor</span><span class="p">(</span><span class="n">id</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sensor</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">ERR</span><span class="p">(</span><span class="s">"Failed to set interval to sensor(0x%x)"</span><span class="p">,</span> <span class="n">id</span><span class="p">);</span>

        <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">sensor</span><span class="o">-&gt;</span><span class="n">set_interval</span><span class="p">(</span><span class="n">val</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">bool</span>
<span class="n">sensorhub_device</span><span class="o">::</span><span class="n">set_batch_latency</span><span class="p">(</span><span class="kt">uint32_t</span> <span class="n">id</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">val</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">sensorhub_sensor</span> <span class="o">*</span><span class="n">sensor</span> <span class="o">=</span> <span class="n">manager</span><span class="o">-&gt;</span><span class="n">get_sensor</span><span class="p">(</span><span class="n">id</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sensor</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">ERR</span><span class="p">(</span><span class="s">"Failed to set batch latency to sensor(0x%x)"</span><span class="p">,</span> <span class="n">id</span><span class="p">);</span>

        <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">sensor</span><span class="o">-&gt;</span><span class="n">set_batch_latency</span><span class="p">(</span><span class="n">val</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">bool</span>
<span class="n">sensorhub_device</span><span class="o">::</span><span class="n">set_attribute_int</span><span class="p">(</span><span class="kt">uint32_t</span> <span class="n">id</span><span class="p">,</span> <span class="kt">int32_t</span> <span class="n">attribute</span><span class="p">,</span> <span class="kt">int32_t</span> <span class="n">value</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

    <span class="n">sensorhub_sensor</span> <span class="o">*</span><span class="n">sensor</span> <span class="o">=</span> <span class="n">manager</span><span class="o">-&gt;</span><span class="n">get_sensor</span><span class="p">(</span><span class="n">id</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sensor</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">ERR</span><span class="p">(</span><span class="s">"Failed to set attribute to sensor(0x%x)"</span><span class="p">,</span> <span class="n">id</span><span class="p">);</span>

        <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">ret</span> <span class="o">=</span> <span class="n">sensor</span><span class="o">-&gt;</span><span class="n">set_attribute_int</span><span class="p">(</span><span class="n">attribute</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">((</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">))</span> <span class="p">{</span>
        <span class="n">ERR</span><span class="p">(</span><span class="s">"Failed to send sensorhub data"</span><span class="p">);</span>

        <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">WARN</span><span class="p">(</span><span class="s">"Command is sent during sensorhub firmware update"</span><span class="p">);</span>

        <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">bool</span>
<span class="n">sensorhub_device</span><span class="o">::</span><span class="n">set_attribute_str</span><span class="p">(</span><span class="kt">uint32_t</span> <span class="n">id</span><span class="p">,</span> <span class="kt">int32_t</span> <span class="n">attribute</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">value</span><span class="p">,</span> <span class="kt">int</span> <span class="n">value_len</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

    <span class="n">sensorhub_sensor</span> <span class="o">*</span><span class="n">sensor</span> <span class="o">=</span> <span class="n">manager</span><span class="o">-&gt;</span><span class="n">get_sensor</span><span class="p">(</span><span class="n">id</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sensor</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">ERR</span><span class="p">(</span><span class="s">"Failed to set attribute to sensor(0x%x)"</span><span class="p">,</span> <span class="n">id</span><span class="p">);</span>

        <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">ret</span> <span class="o">=</span> <span class="n">sensor</span><span class="o">-&gt;</span><span class="n">set_attribute_str</span><span class="p">(</span><span class="n">attribute</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">value_len</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">((</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">))</span> <span class="p">{</span>
        <span class="n">ERR</span><span class="p">(</span><span class="s">"Failed to send sensorhub data"</span><span class="p">);</span>

        <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">WARN</span><span class="p">(</span><span class="s">"Command is sent during sensorhub firmware update"</span><span class="p">);</span>

        <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="n">sensorhub_device</span><span class="o">::</span><span class="n">read_fd</span><span class="p">(</span><span class="kt">uint32_t</span> <span class="o">**</span><span class="n">ids</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">sensorhub_data_t</span> <span class="n">data</span><span class="p">;</span>

    <span class="cm">/* Step 1 */</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">controller</span><span class="o">-&gt;</span><span class="n">read_fd</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

    <span class="cm">/* Step 2 */</span>
    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">hub_data</span> <span class="o">=</span> <span class="n">data</span><span class="p">.</span><span class="n">values</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">data_len</span> <span class="o">=</span> <span class="n">data</span><span class="p">.</span><span class="n">value_count</span><span class="p">;</span>

    <span class="cm">/* Step 3 */</span>
    <span class="n">event_ids</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span>

    <span class="k">while</span> <span class="p">(</span><span class="n">data_len</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">DBG</span><span class="p">(</span><span class="s">"Remaining data length: %d"</span><span class="p">,</span> <span class="n">data_len</span><span class="p">);</span>
        <span class="kt">int</span> <span class="n">parsed</span> <span class="o">=</span> <span class="n">parse</span><span class="p">(</span><span class="n">hub_data</span><span class="p">,</span> <span class="n">data_len</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">parsed</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">ERR</span><span class="p">(</span><span class="s">"Parsing failed"</span><span class="p">);</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="n">data_len</span> <span class="o">-=</span> <span class="n">parsed</span><span class="p">;</span>
        <span class="n">hub_data</span> <span class="o">+=</span> <span class="n">parsed</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="cm">/* Step 4 */</span>
    <span class="kt">int</span> <span class="n">size</span> <span class="o">=</span> <span class="n">event_ids</span><span class="p">.</span><span class="n">size</span><span class="p">();</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">event_ids</span><span class="p">.</span><span class="n">empty</span><span class="p">())</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

    <span class="o">*</span><span class="n">ids</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">event_ids</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

    <span class="k">return</span> <span class="n">size</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="n">sensorhub_device</span><span class="o">::</span><span class="n">get_data</span><span class="p">(</span><span class="kt">uint32_t</span> <span class="n">id</span><span class="p">,</span> <span class="n">sensor_data_t</span> <span class="o">**</span><span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">length</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">remains</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

    <span class="n">sensorhub_sensor</span> <span class="o">*</span><span class="n">sensor</span> <span class="o">=</span> <span class="n">manager</span><span class="o">-&gt;</span><span class="n">get_sensor</span><span class="p">(</span><span class="n">id</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sensor</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">ERR</span><span class="p">(</span><span class="s">"Failed to get data from sensor(0x%x)"</span><span class="p">,</span> <span class="n">id</span><span class="p">);</span>

        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">remains</span> <span class="o">=</span> <span class="n">sensor</span><span class="o">-&gt;</span><span class="n">get_data</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">length</span><span class="p">);</span>

    <span class="k">return</span> <span class="n">remains</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">bool</span>
<span class="n">sensorhub_device</span><span class="o">::</span><span class="n">flush</span><span class="p">(</span><span class="kt">uint32_t</span> <span class="n">id</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="n">sensorhub_device</span><span class="o">::</span><span class="n">parse</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">hub_data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">data_len</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">parse_data</span><span class="p">(</span><span class="n">hub_data</span><span class="p">,</span> <span class="n">data_len</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="n">sensorhub_device</span><span class="o">::</span><span class="n">parse_data</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">hub_data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">data_len</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">cursor</span> <span class="o">=</span> <span class="n">hub_data</span><span class="p">;</span>
    <span class="kt">int32_t</span> <span class="n">libtype</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="n">sensorhub_sensor</span> <span class="o">*</span><span class="n">sensor</span> <span class="o">=</span> <span class="n">manager</span><span class="o">-&gt;</span><span class="n">get_sensor</span><span class="p">(</span><span class="n">libtype</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sensor</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">ERR</span><span class="p">(</span><span class="s">"Unknown Sensorhub lib type: %d"</span><span class="p">,</span> <span class="n">libtype</span><span class="p">);</span>

        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">event_ids</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">sensor</span><span class="o">-&gt;</span><span class="n">get_id</span><span class="p">());</span>

    <span class="k">return</span> <span class="n">sensor</span><span class="o">-&gt;</span><span class="n">parse</span><span class="p">(</span><span class="n">cursor</span><span class="p">,</span> <span class="n">data_len</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="n">sensorhub_device</span><span class="o">::</span><span class="n">parse_debug</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">hub_data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">data_len</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include &lt;unistd.h&gt;
#include &lt;string.h&gt;
#include &lt;fcntl.h&gt;
#include &lt;sys/stat.h&gt;
#include &lt;dirent.h&gt;
#include &lt;linux/input.h&gt;
#include &lt;sys/ioctl.h&gt;
#include &lt;fstream&gt;
</span>
<span class="cp">#include &lt;sensor_log.h&gt;
#include &lt;util.h&gt;
#include "sensorhub_controller.h"
</span>
<span class="n">sensorhub_controller</span><span class="o">::</span><span class="n">sensorhub_controller</span><span class="p">()</span>
<span class="o">:</span> <span class="n">m_enabled</span><span class="p">(</span><span class="nb">false</span><span class="p">)</span>
<span class="p">,</span> <span class="n">m_poll_node</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<span class="p">,</span> <span class="n">m_data_node</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{}</span>

<span class="n">sensorhub_controller</span><span class="o">::~</span><span class="n">sensorhub_controller</span><span class="p">()</span> <span class="p">{}</span>

<span class="n">sensorhub_controller</span><span class="o">&amp;</span> <span class="n">sensorhub_controller</span><span class="o">::</span><span class="n">get_instance</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">static</span> <span class="n">sensorhub_controller</span> <span class="n">instance</span><span class="p">;</span>

    <span class="k">return</span> <span class="n">instance</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="n">sensorhub_controller</span><span class="o">::</span><span class="n">get_poll_fd</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
    <span class="cm">/* Returns the sensorhub fd */</span>

    <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">bool</span>
<span class="n">sensorhub_controller</span><span class="o">::</span><span class="n">enable</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">m_enabled</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
    <span class="n">INFO</span><span class="p">(</span><span class="s">"Enable Sensorhub"</span><span class="p">);</span>

    <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">bool</span>
<span class="n">sensorhub_controller</span><span class="o">::</span><span class="n">disable</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">m_enabled</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
    <span class="n">INFO</span><span class="p">(</span><span class="s">"Disable Sensorhub"</span><span class="p">);</span>

    <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="n">sensorhub_controller</span><span class="o">::</span><span class="n">open_input_node</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">input_node</span><span class="p">)</span> <span class="p">{</span>
    <span class="cm">/* Implements the specific sensorhub logic */</span>

    <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">bool</span>
<span class="n">sensorhub_controller</span><span class="o">::</span><span class="n">read_fd</span><span class="p">(</span><span class="n">sensorhub_data_t</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">)</span> <span class="p">{</span>
    <span class="cm">/* Implements the specific sensorhub logic */</span>

    <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="n">sensorhub_controller</span><span class="o">::</span><span class="n">read_sensorhub_data</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
    <span class="cm">/* Implements the specific sensorhub logic */</span>

    <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="n">sensorhub_controller</span><span class="o">::</span><span class="n">read_large_sensorhub_data</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
    <span class="cm">/* Implements the specific sensorhub logic */</span>

    <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="n">sensorhub_controller</span><span class="o">::</span><span class="n">send_sensorhub_data</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">data_len</span><span class="p">)</span> <span class="p">{</span>
    <span class="cm">/* Implements the specific sensorhub logic */</span>

    <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="n">sensorhub_controller</span><span class="o">::</span><span class="n">print_sensorhub_data</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">name</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">length</span><span class="p">)</span> <span class="p">{</span>
    <span class="cm">/* Implements the specific sensorhub logic */</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="references">References</h3>

<p>The reference kernel configuration for sensors varies depending on vendor types. However, there is a standard kernel subsystem for sensors: the Industrial I/O (IIO) subsystem. IIO is intended to provide support for devices that are, in some sense, analog to digital or digital to analog.
For more information, see <a href="https://wiki.analog.com/software/linux/docs/iio/iio">https://wiki.analog.com/software/linux/docs/iio/iio</a>.</p>

<p>The following table lists some example kernel configurations.</p>

<p><strong>Table: Example kernel configurations</strong></p>

<table>
  <thead>
    <tr>
      <th>Sensor component</th>
      <th>Kernel configuration</th>
      <th>Device nodes</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>Accelerometer</td>
      <td><code class="highlighter-rouge">CONFIG_INPUT_KR3DH</code></td>
      <td><code class="highlighter-rouge">/dev/input/event0/</code>, <code class="highlighter-rouge">/dev/input/event1/</code>, <code class="highlighter-rouge">/dev/input/event2/</code>, <code class="highlighter-rouge">/dev/input/event3/</code>, <code class="highlighter-rouge">/dev/input/event4/</code>, <code class="highlighter-rouge">/dev/input/event5/</code></td>
    </tr>
    <tr>
      <td>Proximity</td>
      <td><code class="highlighter-rouge">CONFIG_INPUT_GP2A</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>Light sensor</td>
      <td><code class="highlighter-rouge">CONFIG_INPUT_GP2A</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>Electronic compass</td>
      <td><code class="highlighter-rouge">CONFIG_SENSORS_AK8975</code></td>
      <td> </td>
    </tr>
  </tbody>
</table>

<h3 id="project-git-repositories">Project Git Repositories</h3>

<p>The following table lists the available project Git repositories.</p>

<p><strong>Table: Git repositories</strong></p>

<table>
  <thead>
    <tr>
      <th>Project</th>
      <th>Repository</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code class="highlighter-rouge">capi-system-sensor</code></td>
      <td><code class="highlighter-rouge">platform/core/api/sensor</code></td>
      <td>Tizen sensor C-API</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">sensord</code></td>
      <td><code class="highlighter-rouge">platform/core/system/sensord</code></td>
      <td>Sensor daemon and libraries for managing sensors and clients</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">sensor-hal-tm1</code></td>
      <td><code class="highlighter-rouge">platform/adaptation/tm1/sensor-hal-tm1</code></td>
      <td>Sensor HAL for the TM1 device</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">sensor-hal-tm2</code></td>
      <td><code class="highlighter-rouge">platform/adaptation/tm2/sensor-hal-tm2</code></td>
      <td>Sensor HAL for the TM2 device</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">sensor-hal-tw1</code></td>
      <td><code class="highlighter-rouge">platform/adaptation/tw1/sensor-hal-tw1</code></td>
      <td>Sensor HAL for the TW1 device</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">sensor-hal-emulator</code></td>
      <td><code class="highlighter-rouge">platform/adaptation/emulator/sensor-hal-emulator</code></td>
      <td>Sensor HAL for the emulator</td>
    </tr>
  </tbody>
</table>

<h3 id="testing-and-verifying-sensors">Testing and Verifying Sensors</h3>

<p>The <code class="highlighter-rouge">sensor-test package</code>, in the <code class="highlighter-rouge">sensord</code> Git repository, provides <code class="highlighter-rouge">sensorctl</code>, a command-line tool for testing sensors. After installing <code class="highlighter-rouge">sensor-test package</code>, you can test sensors using the following commands:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ sensorctl test accelerometer
$ sensorctl test gyroscope
$ sensorctl test accelerometer 100 /* enable accelerometer with interval 100 ms */
$ sensorctl test accelerometer 100 1000 /* enable accelerometer with interval 100 ms and 1s batch latency */
$ sensorctl test accelerometer 100 1000 0 /* enable accelerometer with interval 100 ms, 1s batch latency and always on option */
$ sensorctl info accelerometer /* retrieve accelerometer sensor information */
</code></pre></div></div>

<h2 id="crash-framework">Crash Framework</h2>

<h3 id="crash-manager">crash-manager</h3>

<p>crash-manager is a tool used to create crash reports when an application gets crashed.
crash-manager is not usually invoked manually, but automatically by the kernel when the crash occurs. crash-manager generates the crash report and attaches the kernel-provided core, if requested. crash-worker package provides the <code class="highlighter-rouge">99-crash-manager.conf</code> file, which configures kernel parameters for crash-manager to get invoked automatically on crash. For more information, see <a href="#99-crash-managerconf"><code class="highlighter-rouge">99-crash-manager.conf</code></a>.</p>

<p>crash-manager consists of the following options:</p>

<table>
  <thead>
    <tr>
      <th>Option</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>-p  –pid=PID</td>
      <td>Specifies the process ID (PID) of the dumped process.</td>
    </tr>
    <tr>
      <td>-u  –uid=UID</td>
      <td>Specifies the real user identifier (UID) of the dumped process.</td>
    </tr>
    <tr>
      <td>-g  –gid=GID</td>
      <td>Specifies the real group identifier (GID) of the dumped process.</td>
    </tr>
    <tr>
      <td>-i  –tid=TID</td>
      <td>Specifies the thread identifier (TID) of the thread that triggered core dump. For more information, see <a href="http://man7.org/linux/man-pages/man5/core.5.html">core(5)</a>.</td>
    </tr>
    <tr>
      <td>-s  –signal=SIG</td>
      <td>Specifies the signal number causing dump.</td>
    </tr>
    <tr>
      <td>-t  –time=TIME</td>
      <td>Specifies the time of dump in seconds since the epoch.</td>
    </tr>
    <tr>
      <td>-l  –live</td>
      <td>Gets the core dump of the running process.</td>
    </tr>
    <tr>
      <td>-k  –kill-after-dump</td>
      <td>Kills after dump (only with –live option).</td>
    </tr>
    <tr>
      <td>-r  –print</td>
      <td>Prints the report path to standard output (stdout).</td>
    </tr>
    <tr>
      <td>-h  –help</td>
      <td>Prints the help message.</td>
    </tr>
  </tbody>
</table>

<p>In addition to handling crashes, crash-manager can create reports from running processes, livedumps. Livedumps contain <code class="highlighter-rouge">core</code> generated from the running process. The <code class="highlighter-rouge">core</code> is not created automatically but need to be requested explicitly by you. crash-manager needs to be invoked with the <code class="highlighter-rouge">--live</code> option, to produce the livedump report:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ /usr/bin/crash-manager -p &lt;PID&gt; --live --print
</code></pre></div></div>

<h4 id="99-crash-managerconf">99-crash-manager.conf</h4>

<p>The <code class="highlighter-rouge">99-crash-manager.conf</code> file consists of the following kernel configurations related to the core dump:</p>

<ul>
  <li>
    <p><strong>kernel.core_pattern</strong><br />
  This value contains the path to the file in which the kernel will store the core dump in case of a process crash. The possible values are described in <a href="http://man7.org/linux/man-pages/man5/core.5.html">core(5)</a>. If the first character of this path is a pipe symbol (<code class="highlighter-rouge">|</code>), then the whole line is interpreted as a program that can be executed, and the core dump will be given as a standard input.
  To disable crash-manager, set this value to an empty string.</p>

    <p>Default value: <code class="highlighter-rouge">"/usr/bin/crash-manager -p %p -u %u -g %g -s %s -t %t"</code></p>
  </li>
  <li>
    <p><strong>kernel.core_pipe_limit</strong><br />
  Defines the maximum number of concurrent processes that may be dumped at the same time. For more information, see <a href="http://man7.org/linux/man-pages/man5/core.5.html">core(5)</a>.
  If the limit is exceeded, then the next crashed process will not be dumped.</p>

    <p>Default value: <code class="highlighter-rouge">10</code></p>
  </li>
  <li>
    <p><strong>fs.suid_dumpable</strong><br />
  Defines whether the core dump is produced for the set-owner-user-ID (SUID) binaries (<a href="http://man7.org/linux/man-pages/man5/proc.5.html">proc(5)</a>) or not.</p>

    <p>Default value: <code class="highlighter-rouge">2</code></p>
  </li>
</ul>

<h4 id="crash-managerconf">crash-manager.conf</h4>

<p>The default configuration file for crash-manager is <code class="highlighter-rouge">/etc/crash-manager.conf</code>. It is used to configure the location, the content and retention policy of crash reports.</p>

<ul>
  <li>
    <p><strong>SystemMaxUse</strong><br />
  Determines the maximum size (in kilobytes) on disk that reports can occupy. If this value is exceeded, then the oldest reports will be deleted.
  Value <code class="highlighter-rouge">0</code> turns off the check.</p>

    <p>Default value: <code class="highlighter-rouge">0</code></p>
  </li>
  <li>
    <p><strong>SystemKeepFree</strong><br />
  If set to a value other than <code class="highlighter-rouge">0</code>, then crash-manager will check whether an appropriate amount of empty space (in kilobytes) is available on the disk or not.
  Value <code class="highlighter-rouge">0</code> turns off the check.</p>

    <p>Default value: <code class="highlighter-rouge">0</code></p>
  </li>
  <li>
    <p><strong>MaxRetentionSec</strong><br />
  Defines the maximal time (in seconds) a report will be kept. Older reports will be deleted.
  Value <code class="highlighter-rouge">0</code> turns off the check.</p>

    <p>Default value: <code class="highlighter-rouge">0</code></p>
  </li>
  <li>
    <p><strong>MaxCrashDump</strong><br />
  Defines how many reports will be kept. In case the number of reports exceeds this value, the oldest reports will be removed.
  Value <code class="highlighter-rouge">0</code> turns off the check.</p>

    <p>Default value: <code class="highlighter-rouge">0</code></p>
  </li>
  <li>
    <p><strong>AllowZip</strong><br />
  Determines whether the report will be compressed or not.</p>

    <p>Default value: <code class="highlighter-rouge">yes</code></p>
  </li>
  <li>
    <p><strong>CoreDump</strong><br />
  If set to <code class="highlighter-rouge">0</code>, then the core dump will be removed from the final report.</p>

    <p>Default value: <code class="highlighter-rouge">1</code></p>
  </li>
  <li><strong>CrashRootPath</strong><br />
  Specifies the directory in which the crash reports will be saved. In the specified path, crash-manager will create four sub-directories:
    <ul>
      <li><code class="highlighter-rouge">dump/</code>: For saved reports of crashed applications</li>
      <li><code class="highlighter-rouge">livedump/</code>: For saved reports of running processes (with option <code class="highlighter-rouge">--live</code>)</li>
      <li><code class="highlighter-rouge">log/</code>: For logs</li>
      <li><code class="highlighter-rouge">temp/</code>: For files while creating report</li>
    </ul>

    <p>Default value: <code class="highlighter-rouge">/opt/user/share/crash/</code></p>
  </li>
  <li><strong>ReportType</strong><br />
  Specifies the type of the crash report. Possible values are:
    <ul>
      <li><code class="highlighter-rouge">INFO</code>: Only the <code class="highlighter-rouge">*.info</code> file will be saved. The <code class="highlighter-rouge">*.info</code> file contains information about the registers and the call stack of the crashed application.</li>
      <li><code class="highlighter-rouge">FULL</code>: The full crash report:
        <ul>
          <li><code class="highlighter-rouge">*.info</code>: Contains information about the registers and the call stack of the crashed application.</li>
          <li><code class="highlighter-rouge">*.coredump</code>: A process memory dump.</li>
          <li><code class="highlighter-rouge">*.so_info</code>: Contains information about shared libraries used by the crashed application, together with the names of packages that contain them.</li>
          <li><code class="highlighter-rouge">*.log</code>: Contains information provided by <a href="#dump_systemstate">dump_systemstate</a>.</li>
          <li>Interesting files (<code class="highlighter-rouge">cmdline</code>, <code class="highlighter-rouge">environ</code>, <code class="highlighter-rouge">io</code>, <code class="highlighter-rouge">maps</code>, <code class="highlighter-rouge">smaps</code>, <code class="highlighter-rouge">stack</code>, <code class="highlighter-rouge">stat</code>, <code class="highlighter-rouge">statm</code>, <code class="highlighter-rouge">cwd</code>, <code class="highlighter-rouge">fd</code>) from the <code class="highlighter-rouge">/proc/&lt;PID&gt;/</code> directory.</li>
        </ul>
      </li>
    </ul>

    <p>Default value: <code class="highlighter-rouge">FULL</code></p>
  </li>
  <li>
    <p><strong>ExtraScript</strong><br />
  Path to a script or an application that will be executed during report creation. The process will be started asynchronously.</p>

    <p>Default value is empty</p>
  </li>
</ul>

<h4 id="disabling-crash-manager">Disabling crash-manager</h4>

<p>In some situations there may be a need to disable the crash-manager functionality. In such cases, the recommended solution is to provide the <code class="highlighter-rouge">sysctl</code> configuration file to overwrite the default <code class="highlighter-rouge">kernel.core_pattern</code> setting. For example, the <code class="highlighter-rouge">99-disable-crash-manager.conf</code> file must be placed in the <code class="highlighter-rouge">/usr/lib/sysctl.d/</code> directory and must contain:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kernel.core_pattern=
kernel.core_uses_pid=0
</code></pre></div></div>

<h3 id="d-bus-notification">D-Bus notification</h3>

<p>After the report is generated, crash-manager sends the D-Bus signal containing the following information about the crashed process:</p>

<p>Signature: <code class="highlighter-rouge">sssssiia{sv}</code><br />
Member: <code class="highlighter-rouge">ProcessCrashed</code><br />
Interface: <code class="highlighter-rouge">org.tizen.system.crash.Crash</code><br />
Path: <code class="highlighter-rouge">/Org/Tizen/System/Crash/Crash</code><br />
Data structure:</p>

<table>
  <thead>
    <tr>
      <th>Data</th>
      <th>Type</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>command name</td>
      <td>STRING</td>
    </tr>
    <tr>
      <td>command path</td>
      <td>STRING</td>
    </tr>
    <tr>
      <td>appid</td>
      <td>STRING</td>
    </tr>
    <tr>
      <td>pkgid</td>
      <td>STRING</td>
    </tr>
    <tr>
      <td>report path</td>
      <td>STRING</td>
    </tr>
    <tr>
      <td>PID</td>
      <td>INT32</td>
    </tr>
    <tr>
      <td>TID</td>
      <td>INT32</td>
    </tr>
    <tr>
      <td>array</td>
      <td>ARRAY</td>
    </tr>
  </tbody>
</table>

<p>Array containing pairs of keys (STRING) and values (VARIANT). Possible keys:</p>

<table>
  <thead>
    <tr>
      <th>Key</th>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>x86.eip</td>
      <td>UINT32</td>
      <td>instruction pointer</td>
    </tr>
    <tr>
      <td>x86_64.rip</td>
      <td>UINT64</td>
      <td>instruction pointer</td>
    </tr>
    <tr>
      <td>arm.pc</td>
      <td>UINT32</td>
      <td>instruction pointer</td>
    </tr>
    <tr>
      <td>arm.lr</td>
      <td>UINT32</td>
      <td>instruction pointer</td>
    </tr>
    <tr>
      <td>aarch64.pc</td>
      <td>UINT64</td>
      <td>instruction pointer</td>
    </tr>
    <tr>
      <td>aarch64.lr</td>
      <td>UINT64</td>
      <td>instruction pointer</td>
    </tr>
    <tr>
      <td>sys.signal</td>
      <td>INT32</td>
      <td>signal that caused crash</td>
    </tr>
    <tr>
      <td>sys.tid.comm</td>
      <td>STRING</td>
      <td>thread name</td>
    </tr>
  </tbody>
</table>

<p>Depending on the architecture, array will contain:</p>

<table>
  <thead>
    <tr>
      <th>Arch</th>
      <th>PC (instruction pointer)</th>
      <th>Link Register</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>x86</td>
      <td>x86.eip</td>
      <td>(not available)</td>
    </tr>
    <tr>
      <td>x86_64</td>
      <td>x86_64.eip</td>
      <td>(not available)</td>
    </tr>
    <tr>
      <td>arm</td>
      <td>arm.pc</td>
      <td>arm.lr</td>
    </tr>
    <tr>
      <td>aarch64</td>
      <td>aarch64.pc</td>
      <td>aarch64.lr</td>
    </tr>
  </tbody>
</table>

<h3 id="minicoredumper">minicoredumper</h3>

<p>minicoredumper is a tool that accepts a core dump on a standard input and saves the modified (size-reduced) core dump in a file. This tool is internally used by crash-manager to generate minicoredump. Modifications depends on the configuration, and they mainly rely on minimization of the core dump file.</p>

<p>Usually, integrator does not need to modify this configuration unless integrator needs to change parameters of minicoredump files or settings for specified applications.</p>

<p>minicoredumper can be used alone by setting <code class="highlighter-rouge">/proc/sys/kernel/core_pattern</code> to <code class="highlighter-rouge">|/usr/bin/minicoredumper %P %u %g %s %t %h %e</code>. All possible <code class="highlighter-rouge">%</code> specifiers are described in <a href="http://man7.org/linux/man-pages/man5/core.5.html">core(5)</a>.</p>

<p>The default path of the configuration file is <code class="highlighter-rouge">/etc/minicoredumper/minicoredumper.cfg.json</code> and the file format is JSON. Possible options are:</p>

<ul>
  <li><strong>base_dir</strong> (string): Defines the root directory where the dumped data will be stored. This option is overwritten by the command line option, which is set by <strong>crash-manager</strong>.</li>
  <li><strong>watch</strong> (array): A set of recepts, which will be used for applications that meet the defined criteria:
    <ul>
      <li><strong>exe</strong> (string): The full path to the binary returned by readlink. The <code class="highlighter-rouge">*</code> character is supported as wildcard. If not specified, the <code class="highlighter-rouge">*</code> value will be used.</li>
      <li><strong>comm</strong> (string): The basename of the command that was run. The <code class="highlighter-rouge">*</code> character is supported as wildcard. If not specified, the <code class="highlighter-rouge">*</code> value will be used.</li>
      <li><strong>recept</strong> (string): The full path to the recept file.</li>
    </ul>

    <blockquote>
      <p><strong>Note</strong></p>

      <p>If <strong>exe</strong> and <strong>comm</strong> are specified, then both conditions must be met to use the recept.</p>
    </blockquote>
  </li>
</ul>

<p>Default minicoredumper.cfg.json:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  {
      "base_dir": "/usr/local/var/crash/minicoredumper",
      "watch": [
          {
              "exe": "/usr/bin/dotnet-launcher",
              "recept": "dotnet.recept.json"
          },
          {
              "recept": "generic.recept.json"
          }
      ]
  }
</code></pre></div></div>

<p>The default path of the recept files is <code class="highlighter-rouge">/etc/minicoredumper/</code> and the format is JSON. Possible options are:</p>

<ul>
  <li><strong>stacks</strong> (list): Contains settings for what should be dumped.
    <ul>
      <li><strong>dump_stacks</strong> (bool): If true, stacks will be dumped.</li>
      <li><strong>first_thread_only</strong> (bool): If true, only the first thread will be dumped.</li>
      <li><strong>max_stack_size</strong> (integer): Maximum size of the stack.</li>
    </ul>
  </li>
  <li><strong>maps</strong> (list): Contains list “dump_by_name”.
    <ul>
      <li><strong>dump_by_name</strong> (list): List of pathnames of memory regions that should be dumped (pathnames are read from <code class="highlighter-rouge">/proc/&lt;PID&gt;/maps</code>).</li>
    </ul>
  </li>
  <li><strong>compression</strong> (list): Contains settings related to report compression.
    <ul>
      <li><strong>compressor</strong> (string): Command line of compressor that supports stdin as input and stdout as output (gzip, bzip2, xz).</li>
      <li><strong>extension</strong>: (string): In case of a compressed core file, the specified value will be appended at the end of the core file name; otherwise, <code class="highlighter-rouge">.compressed</code> will be appended to the compressed core files.</li>
      <li><strong>in_tar</strong> (bool): Determines whether the core file should be a <code class="highlighter-rouge">.tar</code> file or not. This is useful because the tar format enables preserving the sparse properties of the core file.</li>
      <li><strong>dump_auxv_so_list</strong> (bool): If true, the shared object list will be saved in the core file.</li>
      <li><strong>dump_pthread_list</strong> (bool): If true, the pthread list will be saved in the core file.</li>
      <li><strong>dump_robust_mutex_list</strong> (bool): If true then robust mutexes will be saved in the core file.</li>
      <li><strong>dump_scope</strong> (int): Only registered dumps at this value or lower than this value will be dumped. This option applies only to libminicoredumper.</li>
      <li><strong>dump_build_id</strong> (bool): If true, then for all the contained ELF files, minicoredumper will save ELF header with BuildID to enable determining a specific version of the shared libraries.</li>
      <li><strong>live_dumper</strong> (bool): If true, then minicoredumper will trigger applications registered by libminicoredumper.</li>
      <li><strong>write_proc_info</strong> (boolean): If true, then interesting files (<code class="highlighter-rouge">cmdline</code>, <code class="highlighter-rouge">environ</code>, <code class="highlighter-rouge">io</code>, <code class="highlighter-rouge">maps</code>, <code class="highlighter-rouge">smaps</code>, <code class="highlighter-rouge">stack</code>, <code class="highlighter-rouge">stat</code>, <code class="highlighter-rouge">statm</code>, <code class="highlighter-rouge">cwd</code>, <code class="highlighter-rouge">fd</code>) from <code class="highlighter-rouge">/proc/&lt;PID&gt;</code> will be copied to the dump directory.</li>
      <li><strong>proc_info_exclude</strong> (list): Contains a list of filenames that must not be copied from the <code class="highlighter-rouge">/proc/</code> directory. For example, copying the <code class="highlighter-rouge">smaps</code> files will significantly increase the dumping time.</li>
      <li><strong>write_debug_log</strong> (bool): If true, then minicoredumper messages will be saved to <code class="highlighter-rouge">debug.txt</code> in the dump directory.</li>
      <li><strong>dump_fat_core</strong> (bool): If true, then all virtual memory areas will be saved in the separate core dump file. This must be used only for debug purpose.</li>
      <li><strong>dump_pointed_by_regs</strong> (bool): If true, then memory region around the address to which the CPU registers point is saved in the core file by minicoredumper. Precisely, for each CPU register minicoredumper saves page to which address points, one page before the address, and one page after the address. Page is 4096 bytes on most architectures.</li>
      <li><strong>full_coredump</strong> (bool): If true, then minicoredumper dumps the full core dump file.</li>
    </ul>
  </li>
</ul>

<p>Default <code class="highlighter-rouge">generic.recept.json</code>:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  {
      "stacks": {
          "dump_stacks": true,
          "first_thread_only": false,
          "max_stack_size": 0
      },
      "maps": {
          "dump_by_name": [
              "[vdso]"
          ]
      },
      "compression": {
          "compressor": "",
          "extension": "",
          "in_tar": true
      },
      "dump_auxv_so_list": true,
      "dump_pthread_list": true,
      "dump_robust_mutex_list": true,
      "dump_scope": 1024,
      "dump_build_id": true,
      "live_dumper": true,
      "write_proc_info": true,
      "proc_info_exclude": [
          "smaps"
      ],
      "write_debug_log": false,
      "dump_fat_core": false,
      "dump_pointed_by_regs": true
  }
</code></pre></div></div>

<h3 id="dump_systemstate">dump_systemstate</h3>

<p><strong>dump_systemstate</strong> is used to dump information that can be useful for developers to fix bugs in the crashed applications.</p>

<p>Default dump contains:</p>
<ul>
  <li>Basic information:
    <ul>
      <li>Binary version from <code class="highlighter-rouge">/etc/info.ini</code></li>
      <li>Tizen version from <code class="highlighter-rouge">/etc/tizen-release</code></li>
      <li>Kernel version from <code class="highlighter-rouge">/proc/version</code></li>
      <li>Boot arguments from <code class="highlighter-rouge">/proc/cmdline</code></li>
      <li>CPU and system architecture from <code class="highlighter-rouge">/proc/cpuinfo</code></li>
      <li>System uptime from <code class="highlighter-rouge">/proc/uptime</code></li>
      <li>Local time from <code class="highlighter-rouge">/opt/etc/localtime</code></li>
    </ul>
  </li>
  <li>Resource usage information:
    <ul>
      <li>System statistics from <code class="highlighter-rouge">/proc/stat</code></li>
      <li>System memory usage from <code class="highlighter-rouge">/proc/meminfo</code></li>
      <li>System disk I/O statistics from <code class="highlighter-rouge">/proc/diskstats</code></li>
      <li>System disk space usage</li>
      <li>System memory statistics</li>
    </ul>
  </li>
  <li>Process information:
    <ul>
      <li>Process information by <code class="highlighter-rouge">ps</code> command</li>
    </ul>
  </li>
  <li>Device information:
    <ul>
      <li>Device major numbers from <code class="highlighter-rouge">/proc/devices</code></li>
    </ul>
  </li>
</ul>

<p>The dump contents of <strong>dump_systemstate</strong> can be modified by the following command line options:</p>

<table>
  <thead>
    <tr>
      <th>Option</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>-f</td>
      <td>write to file (instead of stdout)</td>
    </tr>
    <tr>
      <td>-k</td>
      <td>dump kernel messages (root only)</td>
    </tr>
    <tr>
      <td>-d</td>
      <td>dump dlog messages</td>
    </tr>
    <tr>
      <td>-j</td>
      <td>dump journal log messages</td>
    </tr>
    <tr>
      <td>-p</td>
      <td>dump list of installed packages</td>
    </tr>
    <tr>
      <td>-e</td>
      <td>dump extras defined in the config</td>
    </tr>
  </tbody>
</table>

<p>Depending on the command line options, <strong>dump_systemstate</strong> can save the output of these commands:</p>

<ul>
  <li><code class="highlighter-rouge">/bin/df -h</code></li>
  <li><code class="highlighter-rouge">/bin/du -ah /opt --exclude=/opt/usr</code></li>
  <li><code class="highlighter-rouge">/bin/ls -al /opt/etc/localtime</code></li>
  <li><code class="highlighter-rouge">/bin/top -bcH -n 1</code></li>
  <li><code class="highlighter-rouge">/bin/ps auxfw</code></li>
  <li><code class="highlighter-rouge">/bin/memps -v</code></li>
  <li><code class="highlighter-rouge">/bin/buxton2ctl dump memory</code></li>
  <li><code class="highlighter-rouge">/bin/buxton2ctl dump system</code></li>
  <li><code class="highlighter-rouge">/usr/bin/pkgcmd -l</code></li>
  <li><code class="highlighter-rouge">/bin/dmesg -T</code></li>
  <li><code class="highlighter-rouge">/bin/dlogutil -d -v threadtime -u 16384</code></li>
  <li><code class="highlighter-rouge">/bin/journalctl -b -n 1024</code></li>
</ul>

<p>There are two types of configuration files, under <code class="highlighter-rouge">files/</code> subdirectory and <code class="highlighter-rouge">programs/</code> subdirectory. These files allow to specify the results of additional files and programs that will be included in the <strong>dump_systemstate</strong> output:</p>

<ul>
  <li><code class="highlighter-rouge">files/</code> subdirectory: Specified files will be appended to the <strong>dump_systemstate</strong> output.
    <ul>
      <li><strong>[SECTION_NAME]</strong></li>
      <li><strong>title</strong>: Title that will be printed before contents of the file</li>
      <li><strong>path</strong>: Path to the file</li>
    </ul>

    <p>Example:</p>

    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  [UNIQUE_ID_KEY]
  title=header line that gets printed (path gets appended too)
  path=/path/to/the/file

  [DLOG_CONF]
  title=dlog configuration file
  path=/opt/etc/dlog.conf
</code></pre></div>    </div>
  </li>
  <li><code class="highlighter-rouge">programs/</code> subdirectory: Specified commands will be executed and the output will be added to the <strong>dump_systemstate</strong> output.
    <ul>
      <li><strong>[SECTION_NAME]</strong></li>
      <li><strong>title</strong>: Title that will be printed before contents of the file</li>
      <li><strong>path</strong>: Path to the application</li>
      <li><strong>args</strong>: Arguments for the application</li>
      <li><strong>env</strong>: Environment variable, which should be passed to the application</li>
    </ul>

    <p>Example:</p>

    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  [UNIQUE_ID_KEY]
  title=header line describing the program (will be printed alongside env, path and args)
  path=/path/to/the/program/executable
  args=-x foo --verbose
  env=POSIXLY_CORRECT=1

  [DLOG_DUMP]
  title=dump dlog contents
  path=/usr/bin/dlogutil
  args=-d
</code></pre></div>    </div>
  </li>
</ul>

<h3 id="livedumper">livedumper</h3>

<p><strong>livedumper</strong> is a tool to save the core dump of the live process.</p>

<p>Usage:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>livedumper [-m] [-P &lt;fd&gt;] [-f &lt;file_name&gt;] &lt;PID&gt;
</code></pre></div></div>

<table>
  <thead>
    <tr>
      <th>Option</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>-f &lt;file_name&gt;</td>
      <td>Saves core dump to the specified file (default livecore.&lt;PID&gt; in current directory).</td>
    </tr>
    <tr>
      <td>-P &lt;fd&gt;</td>
      <td>Descriptor for the registers structure (used by crash-manager).</td>
    </tr>
    <tr>
      <td>-m</td>
      <td>Saves minicore. Saves minimum information that allows to restore the call stack.</td>
    </tr>
  </tbody>
</table>

<p>Example:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  $ sleep 123 &amp;
  $ livedumper -f sleep.core -m $?
</code></pre></div></div>

								
            						


  <div id="disqus_thread"></div>
  <script>
    var disqus_config = function () {
      this.page.url = 'https://samsung-test.github.io/latest//platform/porting/system/';
      this.page.identifier = 'https://samsung-test.github.io/latest//platform/porting/system/';
    };
    (function() {
      var d = document, s = d.createElement('script');
      s.src = 'https://samsung-test.disqus.com/embed.js';
      s.setAttribute('data-timestamp', +new Date());
      (d.head || d.body).appendChild(s);
    })();
  </script>
  <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>


         						
							</div>
						</section>
					</main>
					<nav class="col-nav">
						<div id="sidebar-nav" class="sidebar hidden-sm hidden-xs">
						    


<div id="navbar" class="nav-sidebar">
    <ul class="nav" id="jsTOCLeftNav">
        
        
        
        
    
        <li>
            <a 
                href="platform/about/index" 
                data-target="#item1" 
                data-toggle="collapse" 
                data-parent="#stacked-menu"
                aria-expanded=" false "
                class=" collapsed "
                >
                    Platform Overview
                    <span class="caret arrow"></span>
            </a>
            

            
            <ul class="nav collapse" aria-expanded="false" id="#item1">
            

                
                <li>
                    
                    
                    <a 
                        href="platform/about/overview/"
                        class=""
                        aria-expanded=" false "
                        data-target="#item1" 
                        data-toggle="collapse" 
                        >
                        Profiles
                        <span class="caret arrow"></span>
                    </a>
                    
                    
                    <ul class="nav collapse" aria-expanded="false" id="#item1">
                    
                        
                        <li>
                            
                            <a 
                                href="platform/about/wearable/"
                                class=""
                                >
                                Wearables
                            </a>
                        </li>
                        
                        <li>
                            
                            <a 
                                href="platform/about/tv/"
                                class=""
                                >
                                TV
                            </a>
                        </li>
                        
                        <li>
                            
                            <a 
                                href="platform/about/mobile/"
                                class=""
                                >
                                Mobile
                            </a>
                        </li>
                        
                    </ul>
                    
                </li>
                
                <li>
                    
                    
                    <a 
                        href="platform/versions/tizen-5-5-m2/"
                        class=""
                        aria-expanded=" false "
                        data-target="#item2" 
                        data-toggle="collapse" 
                        >
                        Versions
                        <span class="caret arrow"></span>
                    </a>
                    
                    
                    <ul class="nav collapse" aria-expanded="false" id="#item2">
                    
                        
                        <li>
                            
                            <a 
                                href="platform/versions/tizen-5-0-m2/"
                                class=""
                                >
                                Tizen 5.0
                            </a>
                        </li>
                        
                        <li>
                            
                            <a 
                                href="platform/versions/tizen-4-0-m2/"
                                class=""
                                >
                                Tizen 4.0 M2
                            </a>
                        </li>
                        
                        <li>
                            
                            <a 
                                href="platform/versions/tizen-4-0-m1/"
                                class=""
                                >
                                Tizen 4.0 M1
                            </a>
                        </li>
                        
                        <li>
                            
                            <a 
                                href="platform/versions/tizen-3-0/"
                                class=""
                                >
                                Tizen 3.0
                            </a>
                        </li>
                        
                    </ul>
                    
                </li>
                
            </ul>
            
        </li>
    
        
        
        
    
        <li>
            <a 
                href="platform/developing/installing/" 
                data-target="#item2" 
                data-toggle="collapse" 
                data-parent="#stacked-menu"
                aria-expanded=" false "
                class=" collapsed "
                >
                    Platform Developing
                    <span class="caret arrow"></span>
            </a>
            

            
            <ul class="nav collapse" aria-expanded="false" id="#item2">
            

                
                <li>
                    
                    
                    <a 
                        href="platform/developing/installing/" 
                        class=""
                        >
                        Installing Development Tools
                    </a>
                    
                </li>
                
                <li>
                    
                    
                    <a 
                        href="platform/developing/setting-up/" 
                        class=""
                        >
                        Setting up Development Environment
                    </a>
                    
                </li>
                
                <li>
                    
                    
                    <a 
                        href="platform/developing/cloning/" 
                        class=""
                        >
                        Cloning Tizen Source Files
                    </a>
                    
                </li>
                
                <li>
                    
                    
                    <a 
                        href="platform/developing/building/" 
                        class=""
                        >
                        Building Packages Locally with GBS
                    </a>
                    
                </li>
                
                <li>
                    
                    
                    <a 
                        href="platform/developing/building-all/" 
                        class=""
                        >
                        Building All Packages Locally with GBS
                    </a>
                    
                </li>
                
                <li>
                    
                    
                    <a 
                        href="platform/developing/contributing/" 
                        class=""
                        >
                        Contributing Code to Tizen
                    </a>
                    
                </li>
                
                <li>
                    
                    
                    <a 
                        href="platform/developing/creating/" 
                        class=""
                        >
                        Creating Tizen Images with MIC
                    </a>
                    
                </li>
                
                <li>
                    
                    
                    <a 
                        href="platform/developing/flashing/" 
                        class=""
                        >
                        Flashing an Image to Device
                    </a>
                    
                </li>
                
                <li>
                    
                    
                    <a 
                        href="platform/developing/tips/" 
                        class=""
                        >
                        Development Tips
                    </a>
                    
                </li>
                
            </ul>
            
        </li>
    
        
        
        
    
        <li>
            <a 
                href="platform/porting/overview/" 
                data-target="#item3" 
                data-toggle="collapse" 
                data-parent="#stacked-menu"
                aria-expanded=" true "
                class=" not-collapsed "
                >
                    Porting
                    <span class="caret arrow"></span>
            </a>
            

            
            <ul class="nav collapse in" aria-expanded="true" id="#item3">
            

                
                <li>
                    
                    
                    <a 
                        href="platform/porting/overview/" 
                        class=""
                        >
                        Overview
                    </a>
                    
                </li>
                
                <li>
                    
                    
                    <a 
                        href="platform/porting/kernel/" 
                        class=""
                        >
                        Kernel
                    </a>
                    
                </li>
                
                <li>
                    
                    
                    <a 
                        href="platform/porting/system/" 
                        class="active currentPage"
                        >
                        System
                    </a>
                    
                </li>
                
                <li>
                    
                    
                    <a 
                        href="platform/porting/graphics-and-ui/" 
                        class=""
                        >
                        Graphics and UI
                    </a>
                    
                </li>
                
            </ul>
            
        </li>
    
        
        
        
    
        <li>
            <a 
                href="platform/reference/gerrit-usage" 
                data-target="#item4" 
                data-toggle="collapse" 
                data-parent="#stacked-menu"
                aria-expanded=" false "
                class=" collapsed "
                >
                    Reference
                    <span class="caret arrow"></span>
            </a>
            

            
            <ul class="nav collapse" aria-expanded="false" id="#item4">
            

                
                <li>
                    
                    
                    <a 
                        href="platform/reference/gerrit-usage/" 
                        class=""
                        >
                        Gerrit
                    </a>
                    
                </li>
                
                <li>
                    
                    
                    <a 
                        href="platform/reference/gbs/gbs-overview/"
                        class=""
                        aria-expanded=" false "
                        data-target="#item2" 
                        data-toggle="collapse" 
                        >
                        Git Build System (GBS)
                        <span class="caret arrow"></span>
                    </a>
                    
                    
                    <ul class="nav collapse" aria-expanded="false" id="#item2">
                    
                        
                        <li>
                            
                            <a 
                                href="platform/reference/gbs/gbs-overview/"
                                class=""
                                >
                                Overview
                            </a>
                        </li>
                        
                        <li>
                            
                            <a 
                                href="platform/reference/gbs/gbs.conf/"
                                class=""
                                >
                                GBS Configuration
                            </a>
                        </li>
                        
                        <li>
                            
                            <a 
                                href="platform/reference/gbs/gbs-maintenance-models/"
                                class=""
                                >
                                GBS Maintenance Models
                            </a>
                        </li>
                        
                    </ul>
                    
                </li>
                
                <li>
                    
                    
                    <a 
                        href="platform/reference/mic/mic-overview/"
                        class=""
                        aria-expanded=" false "
                        data-target="#item3" 
                        data-toggle="collapse" 
                        >
                        MIC Image Creator
                        <span class="caret arrow"></span>
                    </a>
                    
                    
                    <ul class="nav collapse" aria-expanded="false" id="#item3">
                    
                        
                        <li>
                            
                            <a 
                                href="platform/reference/mic/mic-overview/"
                                class=""
                                >
                                Overview
                            </a>
                        </li>
                        
                        <li>
                            
                            <a 
                                href="platform/reference/mic/mic-customize-image/"
                                class=""
                                >
                                Customizing Images
                            </a>
                        </li>
                        
                        <li>
                            
                            <a 
                                href="platform/reference/mic/mic-reference/"
                                class=""
                                >
                                MIC Reference
                            </a>
                        </li>
                        
                    </ul>
                    
                </li>
                
            </ul>
            
        </li>
    
        
        
    </ul>
</div>
<script>
    $("a[href$='/platform/porting/system/']").addClass("active currentPage");
</script>
						</div>
					</nav>
					<div class="col-toc">
						<div class="sidebar hidden-xs hidden-sm">
							<div class="toc-nav">
								<div class="feedback-links">
									<ul>
										<li>
                                            <a href="https://github.com/samsung-test/samsung-test.github.io/edit/5.5/platform/porting/system.md" target="_blank">
                                                <i class="fa fa-pencil-square-o" aria-hidden="true"></i>
                                                Edit Page
                                            </a>
                                        </li>
                                        <li>
                                            <a href="https://github.com/samsung-test/samsung-test.github.io/issues/new" class="nomunge" target="_blank">
                                                <i class="fa fa-exclamation-circle" aria-hidden="true"></i>
                                                Report Issue
                                            </a>
                                        </li>
									</ul>
								</div>
								   
									<div id="side-toc-title">On this page:</div>
									
<ul id="my_toc" class="inline_toc">
  <li><a href="#partition-and-file-system" class="nomunge">Partition and File System</a>
    <ul>
      <li><a href="#supported-file-systems" class="nomunge">Supported File Systems</a></li>
      <li><a href="#file-system-hierarchy" class="nomunge">File System Hierarchy</a></li>
    </ul>
  </li>
  <li><a href="#system-framework" class="nomunge">System Framework</a>
    <ul>
      <li><a href="#systemd" class="nomunge">systemd</a></li>
      <li><a href="#resourced" class="nomunge">resourced</a></li>
      <li><a href="#deviced" class="nomunge">deviced</a></li>
      <li><a href="#dlog" class="nomunge">dlog</a></li>
      <li><a href="#porting-the-smart-development-bridge-sdb" class="nomunge">Porting the Smart Development Bridge (SDB)</a></li>
      <li><a href="#porting-the-device-hal-interface" class="nomunge">Porting the Device HAL Interface</a></li>
    </ul>
  </li>
  <li><a href="#sensor-framework" class="nomunge">Sensor Framework</a>
    <ul>
      <li><a href="#porting-the-hal-interface" class="nomunge">Porting the HAL Interface</a></li>
      <li><a href="#references" class="nomunge">References</a></li>
      <li><a href="#project-git-repositories" class="nomunge">Project Git Repositories</a></li>
      <li><a href="#testing-and-verifying-sensors" class="nomunge">Testing and Verifying Sensors</a></li>
    </ul>
  </li>
  <li><a href="#crash-framework" class="nomunge">Crash Framework</a>
    <ul>
      <li><a href="#crash-manager" class="nomunge">crash-manager</a></li>
      <li><a href="#d-bus-notification" class="nomunge">D-Bus notification</a></li>
      <li><a href="#minicoredumper" class="nomunge">minicoredumper</a></li>
      <li><a href="#dump_systemstate" class="nomunge">dump_systemstate</a></li>
      <li><a href="#livedumper" class="nomunge">livedumper</a></li>
    </ul>
  </li>
</ul>


								</div>
								
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
	
    <div class="container-fluid">
  <div class="top_footer">
    <div class="footer-nav">
      <nav class="footer_sub_nav">
        <ul class="menu">
          <li><a href="https://developer.tizen.org/">Developer</a></li>
          <li><a href="https://dashboard.tizen.org/">Dashboard</a></li>
          <li><a href="https://craftroom.tizen.org/">Craftroom</a></li>
        </ul>
      </nav>
    </div>
  </div>
  <div class="bottom_footer">
    <div class="footer-copyright col-xs-12 col-md-8">
      <p class="copyright">
        Copyright &copy; 2019 Tizen Inc. All rights reserved.
      </p>
    </div>
    <div class="footer_social_nav">
      <ul class="nav-social">
        <li class="fa fa-github"><a href="https://github.com/samsung-test">GitHub</a></li>  
        <li class="fa fa-twitter"><a href="https://twitter.com/TizenProject">Twitter</a></li>
        <li class="fa fa-facebook"><a href="http://www.facebook.com/pages/Tizen-Project">Facebook</a></li>
      </ul>
    </div>
  </div>
</div>


    <div id="templates"></div>
    <script type="text/javascript" src="/js/jquery-3.2.1.min.js"></script>
<script type="text/javascript" src="/js/bootstrap.min.js"></script>
<script type="text/javascript" src="/js/common.js?v=23122019"></script>
<script type="text/javascript" src="/js/handlebars-v4.0.11.js?v=23122019"></script>
<script type="text/javascript" src="/js/widgets-data.js?v=23122019"></script>
<script type="text/javascript" src="/js/widgets.js?v=23122019"></script>
<script type="text/javascript" src="/js/highlight.pack.js"></script>
<script type="text/javascript" src="/js/tocs.js"></script>
<script type="text/javascript" src="/js/menu.js"></script>
<script type="text/javascript" src="/js/stickyfill.min.js"></script>
<script type="text/javascript" src="/js/metadata.js"></script>
<script type="text/javascript" src="/js/docs.js"></script>

</body>
</html>
